import{O as o,C as O}from"./bsConstants-VORo0MhK.js";function L(c){return c.type==="IMAGE"}class m{static PLAYER="PLAYER";static PARTY="PARTY";static LOCALITEMS="LOCALITEMS";static SCENEITEMS="SCENEITEMS";static SCENEMETA="SCENEMETADATA";static SCENEGRID="SCENEGRID";static ROOMMETA="ROOMMETADATA";debouncedOnSceneItemsChange;debouncedOnSceneMetadataChange;debouncedOnPartyChange;playerId;playerConnection;playerColor;playerName;playerMetadata;playerRole;currentDealer;party;lastParty;gridDpi;gridScale;sceneItems;sceneSelected;sceneMetadata;sceneReady;roomMetadata;theme;caches;USER_REGISTERED;disableBadgeText;savedData;savedDateActionText;sceneMetadataHandler;localItemsHandler;sceneItemsHandler;sceneGridHandler;sceneReadyHandler;playerHandler;partyHandler;themeHandler;roomHandler;constructor(e){this.playerId="",this.playerConnection="",this.playerName="",this.playerColor="",this.playerMetadata={},this.playerRole="PLAYER",this.currentDealer="",this.party=[],this.lastParty=[],this.sceneItems=[],this.sceneSelected=[],this.sceneMetadata={},this.gridDpi=0,this.gridScale=5,this.sceneReady=!1,this.theme="DARK",this.roomMetadata={},this.USER_REGISTERED=!1,this.caches=e,this.debouncedOnSceneItemsChange=U(this.OnSceneItemsChange.bind(this),100),this.debouncedOnSceneMetadataChange=U(this.OnSceneMetadataChanges.bind(this),100),this.debouncedOnPartyChange=U(this.OnPartyChange.bind(this),100)}async InitializeCache(){this.sceneReady=await o.scene.isReady(),this.theme=await o.theme.getTheme(),w(this.theme,document),this.caches.includes(m.PLAYER)&&(this.playerId=await o.player.getId(),this.playerConnection=await o.player.getConnectionId(),this.playerName=await o.player.getName(),this.playerColor=await o.player.getColor(),this.playerMetadata=await o.player.getMetadata(),this.playerRole=await o.player.getRole()),this.caches.includes(m.PARTY)&&(this.party=await o.party.getPlayers(),this.lastParty=this.party),this.caches.includes(m.SCENEITEMS)&&this.sceneReady&&(this.sceneItems=await o.scene.items.getItems()),this.caches.includes(m.SCENEMETA)&&this.sceneReady&&(this.sceneMetadata=await o.scene.getMetadata()),this.caches.includes(m.SCENEGRID)&&this.sceneReady&&(this.gridDpi=await o.scene.grid.getDpi(),this.gridScale=(await o.scene.grid.getScale()).parsed?.multiplier??5),this.caches.includes(m.ROOMMETA)&&(this.roomMetadata=await o.room.getMetadata(),this.disableBadgeText=this.roomMetadata[`${O.EXTENSIONID}/bdOff${this.playerId}`],this.savedData=this.roomMetadata[`${O.EXTENSIONID}/saveData`]),await this.CheckRegistration()}KillHandlers(){this.caches.includes(m.SCENEMETA)&&this.sceneMetadataHandler!==void 0&&this.sceneMetadataHandler(),this.caches.includes(m.SCENEITEMS)&&this.sceneItemsHandler!==void 0&&this.sceneItemsHandler(),this.caches.includes(m.SCENEITEMS)&&this.localItemsHandler!==void 0&&this.localItemsHandler(),this.caches.includes(m.SCENEGRID)&&this.sceneGridHandler!==void 0&&this.sceneGridHandler(),this.caches.includes(m.PLAYER)&&this.playerHandler!==void 0&&this.playerHandler(),this.caches.includes(m.PARTY)&&this.partyHandler!==void 0&&this.partyHandler(),this.caches.includes(m.ROOMMETA)&&this.roomHandler!==void 0&&this.roomHandler(),this.themeHandler!==void 0&&this.themeHandler()}SetupHandlers(){(this.sceneMetadataHandler===void 0||this.sceneMetadataHandler.length===0)&&this.caches.includes(m.SCENEMETA)&&(this.sceneMetadataHandler=o.scene.onMetadataChange(async e=>{this.sceneMetadata=e,this.debouncedOnSceneMetadataChange(e)})),(this.sceneItemsHandler===void 0||this.sceneItemsHandler.length===0)&&this.caches.includes(m.SCENEITEMS)&&(this.sceneItemsHandler=o.scene.items.onChange(async e=>{this.sceneItems=e,this.debouncedOnSceneItemsChange(e)})),(this.sceneGridHandler===void 0||this.sceneGridHandler.length===0)&&this.caches.includes(m.SCENEGRID)&&(this.sceneGridHandler=o.scene.grid.onChange(async e=>{this.gridDpi=e.dpi,this.gridScale=parseInt(e.scale),await this.OnSceneGridChange(e)})),(this.playerHandler===void 0||this.playerHandler.length===0)&&this.caches.includes(m.PLAYER)&&(this.playerHandler=o.player.onChange(async e=>{this.playerName=e.name,this.playerColor=e.color,this.playerId=e.id,this.playerConnection=e.connectionId,this.playerRole=e.role,this.playerMetadata=e.metadata,await this.OnPlayerChange(e)})),(this.partyHandler===void 0||this.partyHandler.length===0)&&this.caches.includes(m.PARTY)&&(this.partyHandler=o.party.onChange(async e=>{this.party=e.filter(t=>t.id!==""),this.debouncedOnPartyChange(e)})),(this.roomHandler===void 0||this.roomHandler.length===0)&&this.caches.includes(m.ROOMMETA)&&(this.roomHandler=o.room.onMetadataChange(async e=>{this.roomMetadata=e,await this.OnRoomMetadataChange(e)})),this.themeHandler===void 0&&(this.themeHandler=o.theme.onChange(async e=>{this.theme=e.mode,await this.OnThemeChange(e)})),this.sceneReadyHandler===void 0&&(this.sceneReadyHandler=o.scene.onReadyChange(async e=>{this.sceneReady=e,e&&(this.sceneItems=await o.scene.items.getItems(L),this.sceneMetadata=await o.scene.getMetadata(),this.gridDpi=await o.scene.grid.getDpi(),this.gridScale=(await o.scene.grid.getScale()).parsed?.multiplier??5),await this.OnSceneReadyChange(e)}))}async CheckRegistration(){try{const e=window.location.origin.includes("localhost")?"eternaldream":"",t={owlbearid:N.playerId},s={method:"POST",headers:new Headers({"Content-Type":"application/json",Authorization:O.ANONAUTH,"x-manuel":e}),body:JSON.stringify(t)},a=await fetch(O.CHECKREGISTRATION,s);if(!a.ok){const l=await a.json();console.error("Error:",l);return}(await a.json()).Data==="OK"?(this.USER_REGISTERED=!0,console.log("Connected")):console.log("Not Registered")}catch(e){console.error("Error:",e)}}async OnSceneMetadataChanges(e){this.playerRole}async OnLocalItemsChange(e){}async OnSceneItemsChange(e){this.sceneReady}async OnSceneGridChange(e){}async OnSceneReadyChange(e){}async OnPlayerChange(e){e.selection?.length}async OnPartyChange(e){}async OnRoomMetadataChange(e){this.disableBadgeText=e[`${O.EXTENSIONID}/bdOff${this.playerId}`],this.savedData=e[`${O.EXTENSIONID}/saveData`];const t=e[`${O.OUTSIDEID}/data`];t&&(Y(t.Timestamp,"Outside","CALENDAR")||(v.CONFIGDAYCURRENTINPUT.value=(+v.CONFIGDAYCURRENTINPUT.value+ +t.Increment).toString(),await v.SetCurrentDate()))}async OnThemeChange(e){w(e,document)}}const N=new m([m.ROOMMETA,m.PLAYER]);function k(c){return`hsl(${(B(c)%360+360)%360}, 70%, 60%)`}function B(c){let e=0;if(c.length===0)return e;for(let t=0;t<c.length;t++){const s=c.charCodeAt(t);e=(e<<5)-e+s,e&=e}return e}function $(){const c=document.createElement("img");return c.id="whatsNewButton",c.style.cursor="pointer",c.setAttribute("class","icon"),c.classList.add("clickable"),c.setAttribute("title","Whats New?"),c.setAttribute("src","/w-info.svg"),c.onclick=async function(){await o.modal.open({id:O.EXTENSIONWHATSNEW,url:`/bswhatsnew.html?subscriber=${N.USER_REGISTERED}`,height:500,width:350})},c}function Y(c,e,t){const s=`${t}_OUTSIDE`,a=c[s];return a?a!==e?(c[s]=e,!1):!0:(c[s]=e,!1)}function U(c,e){let t;return function(...a){t&&clearTimeout(t),t=setTimeout(()=>{c(...a),t=void 0},e)}}function w(c,e){const t=window.matchMedia("(prefers-color-scheme: dark)"),s=t.matches?"dark":"light",a=t.matches?"light":"dark";for(var n=0;n<e.styleSheets.length;n++)for(var l=0;l<e.styleSheets[n].cssRules.length;l++){let r=e.styleSheets[n].cssRules[l];r&&r.media&&r.media.mediaText.includes("prefers-color-scheme")&&(c.mode=="LIGHT"?(r.media.appendMedium(`(prefers-color-scheme: ${s})`),r.media.mediaText.includes(a)&&r.media.deleteMedium(`(prefers-color-scheme: ${a})`)):c.mode=="DARK"&&(r.media.appendMedium(`(prefers-color-scheme: ${a})`),r.media.mediaText.includes(s)&&r.media.deleteMedium(`(prefers-color-scheme: ${s})`)))}}async function x(){await N.InitializeCache(),await v.InitializeCalendar(),N.SetupHandlers()}o.onReady(async()=>{await x()});class W{TABCONTROLS=document.getElementById("tabControls");MAINPANEL=document.getElementById("calendarPanel");MAINBUTTON=document.getElementById("calendarButton");MOONCONTAINER=document.getElementById("calendarMoonContainer");CALENDARCONTAINER=document.getElementById("calendarContainer");TITLECONTAINER=document.getElementById("calendarTitleContainer");CONFIGPANEL=document.getElementById("configPanel");CONFIGBUTTON=document.getElementById("configButton");CONFIGNAMEINPUT=document.getElementById("configName");CONFIGMONTHINPUT=document.getElementById("configMonth");CONFIGMONTHSNUMINPUT=document.getElementById("configMonthsNum");CONFIGMONTHSINPUTCONTAINER=document.getElementById("configMonthInputContainer");CONFIGDAYSPERWEEKINPUT=document.getElementById("configDaysPerWeek");CONFIGDAYSYEARSTARTINPUT=document.getElementById("configDaysYearStart");CONFIGDAYCURRENTINPUT=document.getElementById("configDayCurrent");CONFIGDAYSINYEARINPUT=document.getElementById("configDaysInYear");CONFIGDAYSINWEEKCONTAINER=document.getElementById("configDayNameContainer");CONFIGMOONSNUMINPUT=document.getElementById("configMoonsNum");CONFIGMOONSINPUTCONTAINER=document.getElementById("configMoonsInputContainer");GENERATEBUTTON=document.getElementById("generateCalendar");IMPORTPANEL=document.getElementById("importPanel");IMPORTBUTTON=document.getElementById("importButton");IMPORTTEXTINPUT=document.getElementById("importTextInput");IMPORTCONFIRMBUTTON=document.getElementById("importConfirmButton");WHATSNEWCONTAINER=document.getElementById("whatsNew");SPELLPROFINPUT=document.getElementById("calendarProfContainer");SPELLDCINPUT=document.getElementById("calendarSpellContainer");roomSavedData;savedDateActionText="";disableBadgeText=!1;debouncedSaveData;viewingMonth=1;shownMonth=1;spellDCValue=1;constructor(){this.roomSavedData={},this.debouncedSaveData=U(this.SaveData,1e3)}async InitializeCalendar(){N.playerRole==="PLAYER"&&(this.TABCONTROLS.style.display="none",this.MAINPANEL.style.height="100%"),await this.SetupCalendar()}async SetupCalendar(){N.savedData?await this.ImportCalendarData(N.savedData):(this.AddDayInputs(),this.AddMonthInputs(),this.AddMoonInput(),await this.GenerateCalendar()),this.WHATSNEWCONTAINER.appendChild($()),this.SetupTabControls(),this.SetupOnChangeEvents(),this.SetupMoonMagic()}SetupOnChangeEvents(){this.CONFIGDAYSPERWEEKINPUT.onchange=async()=>await this.SetCurrentDate(),this.CONFIGDAYCURRENTINPUT.onchange=async()=>await this.SetCurrentDate(),this.CONFIGDAYSPERWEEKINPUT.onchange=()=>this.AddDayInputs(),this.CONFIGMOONSNUMINPUT.onchange=()=>this.AddMoonInput(),this.CONFIGMONTHSNUMINPUT.onchange=()=>this.AddMonthInputs(),this.GENERATEBUTTON.onclick=async()=>{await this.GenerateCalendar();const e=this.CreateSaveFile();await o.room.setMetadata({[`${O.EXTENSIONID}/saveData`]:e}),this.MAINBUTTON.click()},this.IMPORTCONFIRMBUTTON.onclick=async()=>await this.ImportCalendarData()}SetupTabControls(){this.MAINBUTTON.onclick=async e=>{e.preventDefault(),this.MAINPANEL.style.display="block",this.MAINBUTTON.classList.add("selected"),this.CONFIGPANEL.style.display="none",this.CONFIGBUTTON.classList.remove("selected"),this.IMPORTPANEL.style.display="none",this.IMPORTBUTTON.classList.remove("selected")},this.CONFIGBUTTON.onclick=async e=>{e.preventDefault(),this.CONFIGPANEL.style.display="block",this.CONFIGBUTTON.classList.add("selected"),this.MAINPANEL.style.display="none",this.MAINBUTTON.classList.remove("selected"),this.IMPORTPANEL.style.display="none",this.IMPORTBUTTON.classList.remove("selected")},this.IMPORTBUTTON.onclick=async e=>{e.preventDefault(),this.IMPORTPANEL.style.display="block",this.IMPORTBUTTON.classList.add("selected"),this.MAINPANEL.style.display="none",this.MAINBUTTON.classList.remove("selected"),this.CONFIGPANEL.style.display="none",this.CONFIGBUTTON.classList.remove("selected")}}SetupMoonMagic(){const e=document.getElementById("calendarSpellContainer"),t=document.createElement("div");let s=0;t.textContent="SpLvl: ",t.classList.add("lunar-magic-label"),t.style.marginTop="4px",e?.appendChild(t);const a=document.createElement("input");a.id="spellInput",a.type="number",a.classList.add("moon-mage-stuff"),a.onchange=f=>{switch(+f.target.value){case 0:s=0;break;case 1:s=0;break;case 2:s=2;break;case 3:s=4;break;case 4:s=6;break;case 5:s=8;break;default:s=8;break}const d=document.querySelectorAll(".moon-dc-label");for(const h of d){const T=+h.getAttribute("data-dc");h.textContent=`Spell DC: ${(T+s).toString()}`}},e?.appendChild(a);const n=document.getElementById("calendarProfContainer"),l=document.createElement("div");l.textContent=" :Prof",l.classList.add("lunar-magic-label"),l.style.marginTop="4px";const r=document.createElement("input");r.id="profInput",r.type="number",r.classList.add("moon-mage-stuff"),n?.appendChild(r),n?.appendChild(l)}AddMonthInputs(){this.CONFIGMONTHSINPUTCONTAINER.innerHTML="";for(let e=1;e<=+this.CONFIGMONTHSNUMINPUT.value;e++){const t=document.createElement("div");t.classList.add("month-input-container"),t.innerHTML=`
            <label for="month${e}Name">Name ${e}:</label>
            <input type="text" id="month${e}Name" name="month${e}Name" value="Month${e}">
    
            <label for="month${e}Days">Days:</label>
            <input type="number" class="input-mini" id="month${e}Days" name="month${e}Days" min="1" value="30">
          `,this.CONFIGMONTHSINPUTCONTAINER.appendChild(t)}}AddDayInputs(){this.CONFIGDAYSINWEEKCONTAINER.innerHTML="";for(let e=1;e<=+this.CONFIGDAYSPERWEEKINPUT.value;e++){const t=document.createElement("div");t.classList.add("day-input-container"),t.innerHTML=`
            <label for="day${e}Name">Day ${e} Name:</label>
            <input type="text" id="day${e}Name" name="day${e}Name" value="Day${e}">
          `,this.CONFIGDAYSINWEEKCONTAINER.appendChild(t)}}AddMoonInput(){this.CONFIGMOONSINPUTCONTAINER.innerHTML="";for(let e=1;e<=+this.CONFIGMOONSNUMINPUT.value;e++){const t=document.createElement("div");t.innerHTML=`
            <label for="moon${e}Name">Name:</label>
            <input type="text" class="moon-input" id="moon${e}Name" name="moon${e}Name" value="Moon${e}">
    
            <label for="moon${e}Cycle">Cycle (days):</label>
            <input type="number" class="input-mini" id="moon${e}Cycle" name="moon${e}Cycle" min="1" value="30">
            </br>
            <label for="moon${e}Shift">â—‹ Shift:</label>
            <input type="number" class="input-mini" id="moon${e}Shift" name="moon${e}Shift" min="0" value="0">
            
            <label for="moon${e}Color">Color(Hex):</label>
            <input type="text" class="moon-input" id="moon${e}Color" name="moon${e}Color" value="#000000">
          `,this.CONFIGMOONSINPUTCONTAINER.appendChild(t)}}GetSpecialValue(e,t,s){return document.getElementById(`${e}${t}${s}`).value}async GenerateCalendar(){const e=[],t=[];for(let i=1;i<=+this.CONFIGMONTHSNUMINPUT.value;i++){const d=this.GetSpecialValue("month",i,"Name"),h=this.GetSpecialValue("month",i,"Days");e.push(d),t.push(h)}const s=[];for(let i=1;i<=+this.CONFIGDAYSPERWEEKINPUT.value;i++){const d=this.GetSpecialValue("day",i,"Name");s.push(d)}const a=document.createElement("div");a.classList.add("calendar-system-container");const n=document.createElement("button");n.classList.add("title-line"),n.title="Click to toggle on/off the Day Tag on the Action button.",n.value=N.disableBadgeText?"OFF":"ON",n.textContent=this.CONFIGNAMEINPUT.value,n.onclick=async i=>{i.preventDefault(),n.value==="ON"?(await o.action.setBadgeText(void 0),await o.room.setMetadata({[`${O.EXTENSIONID}/bdOff${N.playerId}`]:!0}),n.value="OFF"):(await o.action.setBadgeText(N.savedDateActionText),await o.room.setMetadata({[`${O.EXTENSIONID}/bdOff${N.playerId}`]:!1}),n.value="ON")},this.TITLECONTAINER.innerHTML="",this.TITLECONTAINER.appendChild(n);const l=parseInt(this.CONFIGDAYSYEARSTARTINPUT.value),r=parseInt(this.CONFIGDAYSPERWEEKINPUT.value);let f=l>r?l%r:l,u=!0;for(let i=0;i<+this.CONFIGMONTHSNUMINPUT.value;i++){const d=document.createElement("button");d.title="View previous Month",d.classList.add("mon-back-button"),d.classList.add("clickable"),d.style.background="url(./month-back.svg) no-repeat center center",d.style.backgroundSize="contain",d.onclick=()=>{let I=this.viewingMonth-1;I<1&&(I=+this.CONFIGMONTHSNUMINPUT.value),this.viewingMonth=I,this.ChangeVisibleMonth()};const h=document.createElement("button");h.title="View next Month",h.classList.add("mon-forward-button"),h.classList.add("clickable"),h.style.background="url(./month-forward.svg) no-repeat center center",h.style.backgroundSize="contain",h.onclick=async()=>{let I=this.viewingMonth+1;I>+this.CONFIGMONTHSNUMINPUT.value&&(I=1),this.viewingMonth=I,this.ChangeVisibleMonth()};const T=document.createElement("table");T.classList.add("calendar-system"),T.id=`monthTable${i}`;const g=T.createTHead(),y=T.createTBody();y.classList.add("month-table-body");const A=e[i]?e[i]:`Month ${(i+1).toString()}`,D=g.insertRow();D.classList.add("month-row");const S=D.insertCell();S.classList.add("month-header-cell"),S.title=A;const C=document.createElement("div");C.classList.add("month-flex-name-container");const E=document.createElement("div");E.innerText=A,E.classList.add("name-div-control-bar"),E.id=`nameDiv${i}`,S.appendChild(C);const p=document.createElement("button");p.title="Select Previous Day",p.classList.add("day-back-button"),p.classList.add("clickable"),p.style.background="url(./day-back.svg) no-repeat center center",p.style.backgroundSize="contain",p.style.display="none",p.id=`dayBackButton${i}`,p.onclick=async()=>{this.CONFIGDAYCURRENTINPUT.value=(+this.CONFIGDAYCURRENTINPUT.value-1).toString(),await this.SetCurrentDate()};const M=document.createElement("button");M.title="Select Next Day",M.classList.add("day-forward-button"),M.classList.add("clickable"),M.style.background="url(./day-forward.svg) no-repeat center center",M.style.backgroundSize="contain",M.style.display="none",M.id=`dayForwardButton${i}`,M.onclick=async()=>{this.CONFIGDAYCURRENTINPUT.value=(+this.CONFIGDAYCURRENTINPUT.value+1).toString(),await this.SetCurrentDate()},E.classList.add("month-name-flex"),N.playerRole==="GM"&&i===parseInt(this.CONFIGMONTHINPUT.value)-1&&(p.style.display="block",M.style.display="block",E.classList.add("current-month-name-flex")),C.appendChild(d),C.appendChild(p),C.appendChild(E),C.appendChild(M),C.appendChild(h),S.colSpan=+this.CONFIGDAYSPERWEEKINPUT.value;const H=g.insertRow();for(const I of s){const P=H.insertCell();P.textContent=I,P.title=I,P.classList.add("day-header")}let R=f;for(let I=1;I<=+t[i];I++){if(u){y.insertRow();const F=y.rows[y.rows.length-1];for(let G=1;G<R;G++)F.insertCell();u=!1}else R===1&&y.insertRow();const b=y.rows[y.rows.length-1].insertCell();b.textContent=`${I}`,b.setAttribute("data-month",(i+1).toString()),b.setAttribute("data-day",I.toString()),b.classList.add("day-cell"),R++,R>+this.CONFIGDAYSPERWEEKINPUT.value&&(R=1)}f=R,u=!0,a.appendChild(T)}this.CALENDARCONTAINER.innerHTML="",this.CALENDARCONTAINER.appendChild(a),this.viewingMonth=+this.CONFIGMONTHINPUT.value,await this.SetCurrentDate()}CreateSaveFile(){const e=[];for(let n=1;n<=+this.CONFIGDAYSPERWEEKINPUT.value;n++){const l=this.GetSpecialValue("day",n,"Name");e.push(l)}const t=[];for(let n=1;n<=+this.CONFIGMONTHSNUMINPUT.value;n++){const l=this.GetSpecialValue("month",n,"Name"),r=this.GetSpecialValue("month",n,"Days");t.push({Name:l,Days:r})}const s=[];for(let n=1;n<=+this.CONFIGMOONSNUMINPUT.value;n++){const l=this.GetSpecialValue("moon",n,"Name"),r=this.GetSpecialValue("moon",n,"Cycle"),f=this.GetSpecialValue("moon",n,"Shift"),u=this.GetSpecialValue("moon",n,"Color");s.push({Name:l,Cycle:r,Shift:f,Color:u})}return{NameYear:this.CONFIGNAMEINPUT.value,CurrentDay:this.CONFIGDAYCURRENTINPUT.value,StartDayYear:(parseInt(this.CONFIGDAYSYEARSTARTINPUT.value)-1).toString(),CurrentMonth:this.CONFIGMONTHINPUT.value,NumberMonth:this.CONFIGMONTHSNUMINPUT.value,DaysPerWeek:this.CONFIGDAYSPERWEEKINPUT.value,NumberMoons:this.CONFIGMOONSNUMINPUT.value,MoonSet:s,MonthSet:t,DaySet:e}}ChangeVisibleMonth(e=!1){const t=document.querySelectorAll(".calendar-system");let s=this.viewingMonth!==+this.CONFIGMONTHINPUT.value?this.viewingMonth:+this.CONFIGMONTHINPUT.value;e&&(s=+this.CONFIGMONTHINPUT.value,this.viewingMonth=s);let a=this.shownMonth<s;for(const n of t)n.id===`monthTable${s-1}`?setTimeout(()=>{this.shownMonth=s,n.style.display="table",n.style.transform=a?"translateX(100%)":"translateX(-100%)",n.offsetHeight,n.style.transform="translateX(0%)",n.style.transition="transform 0.2s ease-in-out"},200):(n.style.transform=a?"translateX(-100%)":"translateX(100%)",n.style.transition="transform 0.2s ease-in-out",setTimeout(()=>{n.style.display="none"},200))}async SetCurrentDate(){const e=this.GetSpecialValue("month",+this.CONFIGMONTHINPUT.value,"Days");if(+this.CONFIGDAYCURRENTINPUT.value>+e){let n=+this.CONFIGMONTHINPUT.value+1;n>+this.CONFIGMONTHSNUMINPUT.value?(this.CONFIGDAYCURRENTINPUT.value="1",this.CONFIGMONTHINPUT.value="1"):(this.CONFIGMONTHINPUT.value=n.toString(),this.CONFIGDAYCURRENTINPUT.value="1")}else if(+this.CONFIGDAYCURRENTINPUT.value<1){let n=+this.CONFIGMONTHINPUT.value-1;if(n<1){const l=this.GetSpecialValue("month",+this.CONFIGMONTHSNUMINPUT.value-1,"Days");this.CONFIGDAYCURRENTINPUT.value=l,this.CONFIGMONTHINPUT.value=this.CONFIGMONTHSNUMINPUT.value}else{const l=this.GetSpecialValue("month",n,"Days");this.CONFIGMONTHINPUT.value=(+this.CONFIGMONTHINPUT.value-1).toString(),this.CONFIGDAYCURRENTINPUT.value=l}}document.querySelectorAll(".calendar-system td").forEach(n=>n.classList.remove("current-date"));const s=document.querySelector(`.calendar-system td[data-month="${this.CONFIGMONTHINPUT.value}"][data-day="${this.CONFIGDAYCURRENTINPUT.value}"]`);s&&s.classList.add("current-date"),this.ChangeVisibleMonth(!0);const a=[];for(let n=1;n<=+this.CONFIGMOONSNUMINPUT.value;n++){const l=this.GetSpecialValue("moon",n,"Name"),r=this.GetSpecialValue("moon",n,"Cycle"),f=this.GetSpecialValue("moon",n,"Shift"),u=this.GetSpecialValue("moon",n,"Color");a.push({name:l,cycle:r,shift:f,color:u})}this.MOONCONTAINER.innerHTML="";for(const n of a){const l=this.GetMoonPhase(+this.CONFIGDAYCURRENTINPUT.value,+n.cycle,+n.shift,n.name,n.color);this.MOONCONTAINER.appendChild(l)}N.playerRole==="GM"&&(this.UpdateDayControls(),this.debouncedSaveData())}async SaveData(){const e=v.CreateSaveFile();await o.room.setMetadata({[`${O.EXTENSIONID}/saveData`]:e});const t=e?.MonthSet[+e.CurrentMonth-1]?.Name;N.savedDateActionText=`${t??e?.CurrentMonth}:${e?.CurrentDay}`,N.disableBadgeText||await o.action.setBadgeText(N.savedDateActionText)}UpdateDayControls(){const e=document.querySelectorAll(".name-div-control-bar");for(const a of e)a.classList.contains("current-month-name-flex")&&(a.classList.remove("current-month-name-flex"),a.classList.add("month-name-flex")),a.id===`nameDiv${parseInt(this.CONFIGMONTHINPUT.value)-1}`&&(a.classList.add("current-month-name-flex"),a.classList.remove("month-name-flex"));const t=document.querySelectorAll(".day-forward-button");for(const a of t)a.id===`dayForwardButton${parseInt(this.CONFIGMONTHINPUT.value)-1}`?a.style.display="block":a.style.display="none";const s=document.querySelectorAll(".day-back-button");for(const a of s)a.id===`dayBackButton${parseInt(this.CONFIGMONTHINPUT.value)-1}`?a.style.display="block":a.style.display="none"}GetMoonPhase(e,t,s,a,n){let l=e;const r=parseInt(this.CONFIGMONTHINPUT.value);for(let E=1;E<r;E++){const p=this.GetSpecialValue("month",E,"Days");l+=parseInt(p)}const u=(l+s-1)%t/t;let i,d,h;u<.0625||u>=.9375?(i="/new_moon.png",d="New Moon",h="20"):u<.1875?(i="/waxing_crescent.png",d="Waxing Crescent",h="15"):u<.3125?(i="/first_quarter.png",d="First Quarter",h="10"):u<.4375?(i="/waxing_gibbous.png",d="Waxing Gibbous",h="8"):u<.5625?(i="/full_moon.png",d="Full Moon",h="5"):u<.6875?(i="/waning_gibbous.png",d="Waning Gibbous",h="8"):u<.8125?(i="/third_quarter.png",d="Third Quarter",h="10"):(i="/waning_crescent.png",d="Waning Crescent",h="15");let T=n||k(a);switch(a){case"Katamba":T="#000000";break;case"Yavash":T="#FF0000";break;case"Xibar":T="#739BD0";break}const g=document.createElement("div");g.classList.add("moon-container");const y=document.createElement("section");y.classList.add("moon-icon"),y.style.setProperty("--moon-color",T),y.title=a;const A=document.createElement("label");A.textContent=a,A.classList.add("moon-name-label");const D=document.createElement("label");D.textContent=`Spell DC: ${+h+this.spellDCValue}`,D.setAttribute("data-dc",h),D.classList.add("moon-dc-label");const S=document.createElement("label");S.textContent=d,S.classList.add("moon-phase-label");const C=document.createElement("img");return C.src=i,C.classList.add("moon-image"),C.title=a,y.appendChild(C),g.appendChild(S),g.appendChild(y),g.appendChild(A),(a==="Xibar"||a==="Katamba"||a==="Yavash")&&(g.appendChild(D),this.SPELLDCINPUT.style.display="flex",this.SPELLPROFINPUT.style.display="flex"),g}async ImportCalendarData(e){let t;try{e?(t=this.TranslateSaveFileToDonJonData(e),this.CONFIGMONTHINPUT.value=e.CurrentMonth,this.CONFIGDAYCURRENTINPUT.value=e.CurrentDay):t=JSON.parse(this.IMPORTTEXTINPUT.value),this.CONFIGNAMEINPUT.value=t.year?t.year:"Default Calendar Name",this.CONFIGMONTHSNUMINPUT.value=t.n_months?t.n_months:"12",this.AddMonthInputs();for(let a=1;a<=t.n_months;a++)document.getElementById(`month${a}Name`).value=t.months[a-1]?t.months[a-1]:`DefaultMonth#${a}`,document.getElementById(`month${a}Days`).value=t.month_len[t.months[a-1]]?t.month_len[t.months[a-1]]:"28";this.CONFIGDAYSPERWEEKINPUT.value=t.weekdays.length>0?t.weekdays.length:"7",this.AddDayInputs();for(let a=1;a<=t.weekdays.length;a++)document.getElementById(`day${a}Name`).value=t.weekdays[a-1]?t.weekdays[a-1]:`DefaultDay#${a}`;this.CONFIGMOONSNUMINPUT.value=t.n_moons?t.n_moons:"2",this.AddMoonInput();for(let a=1;a<=t.n_moons;a++)document.getElementById(`moon${a}Name`).value=t.moons[a-1]?t.moons[a-1]:`DefaultMoon#${a}`,document.getElementById(`moon${a}Cycle`).value=t.lunar_cyc[t.moons[a-1]]?t.lunar_cyc[t.moons[a-1]]:"28",document.getElementById(`moon${a}Shift`).value=t.lunar_shf[t.moons[a-1]]?t.lunar_shf[t.moons[a-1]]:"0",t.lunar_col&&(document.getElementById(`moon${a}Color`).value=t.lunar_col[t.moons[a-1]]?t.lunar_col[t.moons[a-1]]:"#000000");this.CONFIGDAYSINYEARINPUT.value=t.year_len?t.year_len:"336",this.CONFIGDAYSYEARSTARTINPUT.value=t.first_day?(parseInt(t.first_day)+1).toString():"1",await this.GenerateCalendar();const s=e?.MonthSet[+e.CurrentMonth-1]?.Name;N.savedDateActionText=`${s??e?.CurrentMonth}:${e?.CurrentDay}`,N.disableBadgeText||await o.action.setBadgeText(N.savedDateActionText),e||(this.MAINBUTTON.click(),await o.notification.show("Calendar Imported Successfully!","SUCCESS"))}catch(s){alert("Invalid Calendar Format."),console.error(s)}}TranslateSaveFileToDonJonData(e){const t={};return t.year=e.NameYear||"Default Calendar Name",t.n_months=e.NumberMonth||"12",t.months=[],t.month_len={},e.MonthSet.forEach((s,a)=>{t.months[a]=s.Name||`DefaultMonth#${a+1}`,t.month_len[t.months[a]]=s.Days||"28"}),t.weekdays=e.DaySet||["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"],t.weekdays.forEach((s,a)=>{t.weekdays[a]=s||`DefaultDay#${a+1}`}),t.n_moons=e.NumberMoons||"2",t.moons=[],t.lunar_cyc={},t.lunar_shf={},t.lunar_col={},e.MoonSet.forEach((s,a)=>{t.moons[a]=s.Name||`DefaultMoon#${a+1}`,t.lunar_cyc[t.moons[a]]=s.Cycle||"28",t.lunar_shf[t.moons[a]]=s.Shift||"0",t.lunar_col[t.moons[a]]=s.Color||"#000000"}),t.year_len=e.DaysPerWeek||"336",t.first_day=e.StartDayYear||"0",t}}const v=new W;
