var Vt=Object.defineProperty;var Ht=(n,e,t)=>e in n?Vt(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var it=(n,e,t)=>(Ht(n,typeof e!="symbol"?e+"":e,t),t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))o(s);new MutationObserver(s=>{for(const i of s)if(i.type==="childList")for(const r of i.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&o(r)}).observe(document,{childList:!0,subtree:!0});function t(s){const i={};return s.integrity&&(i.integrity=s.integrity),s.referrerPolicy&&(i.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?i.credentials="include":s.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function o(s){if(s.ep)return;s.ep=!0;const i=t(s);fetch(s.href,i)}})();var b=function(n,e,t,o){function s(i){return i instanceof t?i:new t(function(r){r(i)})}return new(t||(t=Promise))(function(i,r){function d(a){try{u(o.next(a))}catch(c){r(c)}}function l(a){try{u(o.throw(a))}catch(c){r(c)}}function u(a){a.done?i(a.value):s(a.value).then(d,l)}u((o=o.apply(n,e||[])).next())})};class Yt{constructor(e){this.messageBus=e}get id(){if(!this.messageBus.userId)throw Error("Unable to get user ID: not ready");return this.messageBus.userId}getSelection(){return b(this,void 0,void 0,function*(){const{selection:e}=yield this.messageBus.sendAsync("OBR_PLAYER_GET_SELECTION",{});return e})}select(e,t){return b(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_PLAYER_SELECT",{items:e,replace:t})})}deselect(e){return b(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_PLAYER_DESELECT",{items:e})})}getName(){return b(this,void 0,void 0,function*(){const{name:e}=yield this.messageBus.sendAsync("OBR_PLAYER_GET_NAME",{});return e})}setName(e){return b(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_PLAYER_SET_NAME",{name:e})})}getColor(){return b(this,void 0,void 0,function*(){const{color:e}=yield this.messageBus.sendAsync("OBR_PLAYER_GET_COLOR",{});return e})}setColor(e){return b(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_PLAYER_SET_COLOR",{color:e})})}getSyncView(){return b(this,void 0,void 0,function*(){const{syncView:e}=yield this.messageBus.sendAsync("OBR_PLAYER_GET_SYNC_VIEW",{});return e})}setSyncView(e){return b(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_PLAYER_SET_SYNC_VIEW",{syncView:e})})}getId(){return b(this,void 0,void 0,function*(){const{id:e}=yield this.messageBus.sendAsync("OBR_PLAYER_GET_ID",{});return e})}getRole(){return b(this,void 0,void 0,function*(){const{role:e}=yield this.messageBus.sendAsync("OBR_PLAYER_GET_ROLE",{});return e})}getMetadata(){return b(this,void 0,void 0,function*(){const{metadata:e}=yield this.messageBus.sendAsync("OBR_PLAYER_GET_METADATA",{});return e})}setMetadata(e){return b(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_PLAYER_SET_METADATA",{update:e})})}hasPermission(e){return b(this,void 0,void 0,function*(){if((yield this.getRole())==="GM")return!0;const{permissions:o}=yield this.messageBus.sendAsync("OBR_ROOM_GET_PERMISSIONS",{});return o.indexOf(e)>-1})}getConnectionId(){return b(this,void 0,void 0,function*(){const{connectionId:e}=yield this.messageBus.sendAsync("OBR_PLAYER_GET_CONNECTION_ID",{});return e})}onChange(e){const t=o=>{e(o.player)};return this.messageBus.send("OBR_PLAYER_SUBSCRIBE",{}),this.messageBus.on("OBR_PLAYER_EVENT_CHANGE",t),()=>{this.messageBus.send("OBR_PLAYER_UNSUBSCRIBE",{}),this.messageBus.off("OBR_PLAYER_EVENT_CHANGE",t)}}}var U=function(n,e,t,o){function s(i){return i instanceof t?i:new t(function(r){r(i)})}return new(t||(t=Promise))(function(i,r){function d(a){try{u(o.next(a))}catch(c){r(c)}}function l(a){try{u(o.throw(a))}catch(c){r(c)}}function u(a){a.done?i(a.value):s(a.value).then(d,l)}u((o=o.apply(n,e||[])).next())})};class jt{constructor(e){this.messageBus=e}reset(){return U(this,void 0,void 0,function*(){const{transform:e}=yield this.messageBus.sendAsync("OBR_VIEWPORT_RESET",{});return e})}animateTo(e){return U(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_VIEWPORT_ANIMATE_TO",{transform:e})})}animateToBounds(e){return U(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_VIEWPORT_ANIMATE_TO_BOUNDS",{bounds:e})})}getPosition(){return U(this,void 0,void 0,function*(){const{position:e}=yield this.messageBus.sendAsync("OBR_VIEWPORT_GET_POSITION",{});return e})}setPosition(e){return U(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_VIEWPORT_SET_POSITION",{position:e})})}getScale(){return U(this,void 0,void 0,function*(){const{scale:e}=yield this.messageBus.sendAsync("OBR_VIEWPORT_GET_SCALE",{});return e})}setScale(e){return U(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_VIEWPORT_SET_SCALE",{scale:e})})}getWidth(){return U(this,void 0,void 0,function*(){const{width:e}=yield this.messageBus.sendAsync("OBR_VIEWPORT_GET_WIDTH",{});return e})}getHeight(){return U(this,void 0,void 0,function*(){const{height:e}=yield this.messageBus.sendAsync("OBR_VIEWPORT_GET_HEIGHT",{});return e})}transformPoint(e){return U(this,void 0,void 0,function*(){const{point:t}=yield this.messageBus.sendAsync("OBR_VIEWPORT_TRANSFORM_POINT",{point:e});return t})}inverseTransformPoint(e){return U(this,void 0,void 0,function*(){const{point:t}=yield this.messageBus.sendAsync("OBR_VIEWPORT_INVERSE_TRANSFORM_POINT",{point:e});return t})}}function Wt(n){return typeof n.id=="string"}var ze={exports:{}},ue=typeof Reflect=="object"?Reflect:null,rt=ue&&typeof ue.apply=="function"?ue.apply:function(e,t,o){return Function.prototype.apply.call(e,t,o)},Te;ue&&typeof ue.ownKeys=="function"?Te=ue.ownKeys:Object.getOwnPropertySymbols?Te=function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:Te=function(e){return Object.getOwnPropertyNames(e)};function Ft(n){console&&console.warn&&console.warn(n)}var It=Number.isNaN||function(e){return e!==e};function g(){g.init.call(this)}ze.exports=g;ze.exports.once=qt;g.EventEmitter=g;g.prototype._events=void 0;g.prototype._eventsCount=0;g.prototype._maxListeners=void 0;var at=10;function Ne(n){if(typeof n!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof n)}Object.defineProperty(g,"defaultMaxListeners",{enumerable:!0,get:function(){return at},set:function(n){if(typeof n!="number"||n<0||It(n))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+n+".");at=n}});g.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0};g.prototype.setMaxListeners=function(e){if(typeof e!="number"||e<0||It(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this};function Mt(n){return n._maxListeners===void 0?g.defaultMaxListeners:n._maxListeners}g.prototype.getMaxListeners=function(){return Mt(this)};g.prototype.emit=function(e){for(var t=[],o=1;o<arguments.length;o++)t.push(arguments[o]);var s=e==="error",i=this._events;if(i!==void 0)s=s&&i.error===void 0;else if(!s)return!1;if(s){var r;if(t.length>0&&(r=t[0]),r instanceof Error)throw r;var d=new Error("Unhandled error."+(r?" ("+r.message+")":""));throw d.context=r,d}var l=i[e];if(l===void 0)return!1;if(typeof l=="function")rt(l,this,t);else for(var u=l.length,a=xt(l,u),o=0;o<u;++o)rt(a[o],this,t);return!0};function bt(n,e,t,o){var s,i,r;if(Ne(t),i=n._events,i===void 0?(i=n._events=Object.create(null),n._eventsCount=0):(i.newListener!==void 0&&(n.emit("newListener",e,t.listener?t.listener:t),i=n._events),r=i[e]),r===void 0)r=i[e]=t,++n._eventsCount;else if(typeof r=="function"?r=i[e]=o?[t,r]:[r,t]:o?r.unshift(t):r.push(t),s=Mt(n),s>0&&r.length>s&&!r.warned){r.warned=!0;var d=new Error("Possible EventEmitter memory leak detected. "+r.length+" "+String(e)+" listeners added. Use emitter.setMaxListeners() to increase limit");d.name="MaxListenersExceededWarning",d.emitter=n,d.type=e,d.count=r.length,Ft(d)}return n}g.prototype.addListener=function(e,t){return bt(this,e,t,!1)};g.prototype.on=g.prototype.addListener;g.prototype.prependListener=function(e,t){return bt(this,e,t,!0)};function Kt(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function wt(n,e,t){var o={fired:!1,wrapFn:void 0,target:n,type:e,listener:t},s=Kt.bind(o);return s.listener=t,o.wrapFn=s,s}g.prototype.once=function(e,t){return Ne(t),this.on(e,wt(this,e,t)),this};g.prototype.prependOnceListener=function(e,t){return Ne(t),this.prependListener(e,wt(this,e,t)),this};g.prototype.removeListener=function(e,t){var o,s,i,r,d;if(Ne(t),s=this._events,s===void 0)return this;if(o=s[e],o===void 0)return this;if(o===t||o.listener===t)--this._eventsCount===0?this._events=Object.create(null):(delete s[e],s.removeListener&&this.emit("removeListener",e,o.listener||t));else if(typeof o!="function"){for(i=-1,r=o.length-1;r>=0;r--)if(o[r]===t||o[r].listener===t){d=o[r].listener,i=r;break}if(i<0)return this;i===0?o.shift():zt(o,i),o.length===1&&(s[e]=o[0]),s.removeListener!==void 0&&this.emit("removeListener",e,d||t)}return this};g.prototype.off=g.prototype.removeListener;g.prototype.removeAllListeners=function(e){var t,o,s;if(o=this._events,o===void 0)return this;if(o.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):o[e]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete o[e]),this;if(arguments.length===0){var i=Object.keys(o),r;for(s=0;s<i.length;++s)r=i[s],r!=="removeListener"&&this.removeAllListeners(r);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(t=o[e],typeof t=="function")this.removeListener(e,t);else if(t!==void 0)for(s=t.length-1;s>=0;s--)this.removeListener(e,t[s]);return this};function Lt(n,e,t){var o=n._events;if(o===void 0)return[];var s=o[e];return s===void 0?[]:typeof s=="function"?t?[s.listener||s]:[s]:t?Xt(s):xt(s,s.length)}g.prototype.listeners=function(e){return Lt(this,e,!0)};g.prototype.rawListeners=function(e){return Lt(this,e,!1)};g.listenerCount=function(n,e){return typeof n.listenerCount=="function"?n.listenerCount(e):Dt.call(n,e)};g.prototype.listenerCount=Dt;function Dt(n){var e=this._events;if(e!==void 0){var t=e[n];if(typeof t=="function")return 1;if(t!==void 0)return t.length}return 0}g.prototype.eventNames=function(){return this._eventsCount>0?Te(this._events):[]};function xt(n,e){for(var t=new Array(e),o=0;o<e;++o)t[o]=n[o];return t}function zt(n,e){for(;e+1<n.length;e++)n[e]=n[e+1];n.pop()}function Xt(n){for(var e=new Array(n.length),t=0;t<e.length;++t)e[t]=n[t].listener||n[t];return e}function qt(n,e){return new Promise(function(t,o){function s(r){n.removeListener(e,i),o(r)}function i(){typeof n.removeListener=="function"&&n.removeListener("error",s),t([].slice.call(arguments))}Pt(n,e,i,{once:!0}),e!=="error"&&Jt(n,s,{once:!0})})}function Jt(n,e,t){typeof n.on=="function"&&Pt(n,"error",e,t)}function Pt(n,e,t,o){if(typeof n.on=="function")o.once?n.once(e,t):n.on(e,t);else if(typeof n.addEventListener=="function")n.addEventListener(e,function s(i){o.once&&n.removeEventListener(e,s),t(i)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof n)}var Qt=ze.exports;let pe;const Zt=new Uint8Array(16);function en(){if(!pe&&(pe=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!pe))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return pe(Zt)}const S=[];for(let n=0;n<256;++n)S.push((n+256).toString(16).slice(1));function tn(n,e=0){return S[n[e+0]]+S[n[e+1]]+S[n[e+2]]+S[n[e+3]]+"-"+S[n[e+4]]+S[n[e+5]]+"-"+S[n[e+6]]+S[n[e+7]]+"-"+S[n[e+8]]+S[n[e+9]]+"-"+S[n[e+10]]+S[n[e+11]]+S[n[e+12]]+S[n[e+13]]+S[n[e+14]]+S[n[e+15]]}const nn=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),ut={randomUUID:nn};function on(n,e,t){if(ut.randomUUID&&!e&&!n)return ut.randomUUID();n=n||{};const o=n.random||(n.rng||en)();if(o[6]=o[6]&15|64,o[8]=o[8]&63|128,e){t=t||0;for(let s=0;s<16;++s)e[t+s]=o[s];return e}return tn(o)}class sn extends Qt.EventEmitter{constructor(e,t){super(),this.ready=!1,this.userId=null,this.ref=null,this.handleMessage=o=>{const s=o.data;if(o.origin===this.targetOrigin&&Wt(s)){if(s.id==="OBR_READY"){this.ready=!0;const i=s.data;this.ref=i.ref,this.userId=i.userId}this.emit(s.id,s.data)}},this.send=(o,s,i)=>{var r;if(!this.ref)throw Error("Unable to send message: not ready");(r=window.parent)===null||r===void 0||r.postMessage({id:o,data:s,ref:this.ref,nonce:i},this.targetOrigin)},this.sendAsync=(o,s,i=5e3)=>{const r=`_${on()}`;return this.send(o,s,r),Promise.race([new Promise((d,l)=>{const u=this;function a(v){u.off(`${o}_RESPONSE${r}`,a),u.off(`${o}_ERROR${r}`,c),d(v)}function c(v){u.off(`${o}_RESPONSE${r}`,a),u.off(`${o}_ERROR${r}`,c),l(v)}this.on(`${o}_RESPONSE${r}`,a),this.on(`${o}_ERROR${r}`,c)}),new Promise((d,l)=>window.setTimeout(()=>l(new Error(`Message ${o} took longer than ${i}ms to get a result`)),i))])},this.roomId=t,this.targetOrigin=e,window.addEventListener("message",this.handleMessage),this.setMaxListeners(100)}destroy(){window.removeEventListener("message",this.handleMessage)}}var ct=function(n,e,t,o){function s(i){return i instanceof t?i:new t(function(r){r(i)})}return new(t||(t=Promise))(function(i,r){function d(a){try{u(o.next(a))}catch(c){r(c)}}function l(a){try{u(o.throw(a))}catch(c){r(c)}}function u(a){a.done?i(a.value):s(a.value).then(d,l)}u((o=o.apply(n,e||[])).next())})};class rn{constructor(e){this.messageBus=e}show(e,t){return ct(this,void 0,void 0,function*(){const{id:o}=yield this.messageBus.sendAsync("OBR_NOTIFICATION_SHOW",{message:e,variant:t});return o})}close(e){return ct(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_NOTIFICATION_CLOSE",{id:e})})}}var se=function(n,e,t,o){function s(i){return i instanceof t?i:new t(function(r){r(i)})}return new(t||(t=Promise))(function(i,r){function d(a){try{u(o.next(a))}catch(c){r(c)}}function l(a){try{u(o.throw(a))}catch(c){r(c)}}function u(a){a.done?i(a.value):s(a.value).then(d,l)}u((o=o.apply(n,e||[])).next())})};class an{constructor(e){this.messageBus=e}getColor(){return se(this,void 0,void 0,function*(){const{color:e}=yield this.messageBus.sendAsync("OBR_SCENE_FOG_GET_COLOR",{});return e})}setColor(e){return se(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_SCENE_FOG_SET_COLOR",{color:e})})}getStrokeWidth(){return se(this,void 0,void 0,function*(){const{strokeWidth:e}=yield this.messageBus.sendAsync("OBR_SCENE_FOG_GET_STROKE_WIDTH",{});return e})}setStrokeWidth(e){return se(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_SCENE_FOG_SET_STROKE_WIDTH",{strokeWidth:e})})}getFilled(){return se(this,void 0,void 0,function*(){const{filled:e}=yield this.messageBus.sendAsync("OBR_SCENE_FOG_GET_FILLED",{});return e})}setFilled(e){return se(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_SCENE_FOG_SET_FILLED",{filled:e})})}onChange(e){const t=o=>{e(o.fog)};return this.messageBus.send("OBR_SCENE_FOG_SUBSCRIBE",{}),this.messageBus.on("OBR_SCENE_FOG_EVENT_CHANGE",t),()=>{this.messageBus.send("OBR_SCENE_FOG_UNSUBSCRIBE",{}),this.messageBus.off("OBR_SCENE_FOG_EVENT_CHANGE",t)}}}var w=function(n,e,t,o){function s(i){return i instanceof t?i:new t(function(r){r(i)})}return new(t||(t=Promise))(function(i,r){function d(a){try{u(o.next(a))}catch(c){r(c)}}function l(a){try{u(o.throw(a))}catch(c){r(c)}}function u(a){a.done?i(a.value):s(a.value).then(d,l)}u((o=o.apply(n,e||[])).next())})};class un{constructor(e){this.messageBus=e}getDpi(){return w(this,void 0,void 0,function*(){const{dpi:e}=yield this.messageBus.sendAsync("OBR_SCENE_GRID_GET_DPI",{});return e})}getScale(){return w(this,void 0,void 0,function*(){return yield this.messageBus.sendAsync("OBR_SCENE_GRID_GET_SCALE",{})})}setScale(e){return w(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_SCENE_GRID_SET_SCALE",{scale:e})})}getColor(){return w(this,void 0,void 0,function*(){const{color:e}=yield this.messageBus.sendAsync("OBR_SCENE_GRID_GET_COLOR",{});return e})}setColor(e){return w(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_SCENE_GRID_SET_COLOR",{color:e})})}getOpacity(){return w(this,void 0,void 0,function*(){const{opacity:e}=yield this.messageBus.sendAsync("OBR_SCENE_GRID_GET_OPACITY",{});return e})}setOpacity(e){return w(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_SCENE_GRID_SET_OPACITY",{opacity:e})})}getType(){return w(this,void 0,void 0,function*(){const{type:e}=yield this.messageBus.sendAsync("OBR_SCENE_GRID_GET_TYPE",{});return e})}setType(e){return w(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_SCENE_GRID_SET_TYPE",{type:e})})}getLineType(){return w(this,void 0,void 0,function*(){const{lineType:e}=yield this.messageBus.sendAsync("OBR_SCENE_GRID_GET_LINE_TYPE",{});return e})}setLineType(e){return w(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_SCENE_GRID_SET_LINE_TYPE",{lineType:e})})}getMeasurement(){return w(this,void 0,void 0,function*(){const{measurement:e}=yield this.messageBus.sendAsync("OBR_SCENE_GRID_GET_MEASUREMENT",{});return e})}setMeasurement(e){return w(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_SCENE_GRID_SET_MEASUREMENT",{measurement:e})})}snapPosition(e,t,o,s){return w(this,void 0,void 0,function*(){const{position:i}=yield this.messageBus.sendAsync("OBR_SCENE_GRID_SNAP_POSITION",{position:e,snappingSensitivity:t,useCorners:o,useCenter:s});return i})}getDistance(e,t){return w(this,void 0,void 0,function*(){const{distance:o}=yield this.messageBus.sendAsync("OBR_SCENE_GRID_GET_DISTANCE",{from:e,to:t});return o})}onChange(e){const t=o=>{e(o.grid)};return this.messageBus.send("OBR_SCENE_GRID_SUBSCRIBE",{}),this.messageBus.on("OBR_SCENE_GRID_EVENT_CHANGE",t),()=>{this.messageBus.send("OBR_SCENE_GRID_UNSUBSCRIBE",{}),this.messageBus.off("OBR_SCENE_GRID_EVENT_CHANGE",t)}}}var ve=function(n,e,t,o){function s(i){return i instanceof t?i:new t(function(r){r(i)})}return new(t||(t=Promise))(function(i,r){function d(a){try{u(o.next(a))}catch(c){r(c)}}function l(a){try{u(o.throw(a))}catch(c){r(c)}}function u(a){a.done?i(a.value):s(a.value).then(d,l)}u((o=o.apply(n,e||[])).next())})};class cn{constructor(e){this.messageBus=e}undo(){return ve(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_SCENE_HISTORY_UNDO",{})})}redo(){return ve(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_SCENE_HISTORY_REDO",{})})}canUndo(){return ve(this,void 0,void 0,function*(){const{canUndo:e}=yield this.messageBus.sendAsync("OBR_SCENE_HISTORY_CAN_UNDO",{});return e})}canRedo(){return ve(this,void 0,void 0,function*(){const{canRedo:e}=yield this.messageBus.sendAsync("OBR_SCENE_HISTORY_CAN_REDO",{});return e})}}function I(n){for(var e=arguments.length,t=Array(e>1?e-1:0),o=1;o<e;o++)t[o-1]=arguments[o];throw Error("[Immer] minified error nr: "+n+(t.length?" "+t.map(function(s){return"'"+s+"'"}).join(","):"")+". Find the full error at: https://bit.ly/3cXEKWf")}function ne(n){return!!n&&!!n[P]}function K(n){var e;return!!n&&(function(t){if(!t||typeof t!="object")return!1;var o=Object.getPrototypeOf(t);if(o===null)return!0;var s=Object.hasOwnProperty.call(o,"constructor")&&o.constructor;return s===Object||typeof s=="function"&&Function.toString.call(s)===En}(n)||Array.isArray(n)||!!n[he]||!!(!((e=n.constructor)===null||e===void 0)&&e[he])||Ie(n)||Me(n))}function ce(n,e,t){t===void 0&&(t=!1),z(n)===0?(t?Object.keys:tt)(n).forEach(function(o){t&&typeof o=="symbol"||e(o,n[o],n)}):n.forEach(function(o,s){return e(s,o,n)})}function z(n){var e=n[P];return e?e.i>3?e.i-4:e.i:Array.isArray(n)?1:Ie(n)?2:Me(n)?3:0}function me(n,e){return z(n)===2?n.has(e):Object.prototype.hasOwnProperty.call(n,e)}function Be(n,e){return z(n)===2?n.get(e):n[e]}function Gt(n,e,t){var o=z(n);o===2?n.set(e,t):o===3?n.add(t):n[e]=t}function dn(n,e){return n===e?n!==0||1/n==1/e:n!=n&&e!=e}function Ie(n){return _n&&n instanceof Map}function Me(n){return yn&&n instanceof Set}function Q(n){return n.o||n.t}function Xe(n){if(Array.isArray(n))return Array.prototype.slice.call(n);var e=pn(n);delete e[P];for(var t=tt(e),o=0;o<t.length;o++){var s=t[o],i=e[s];i.writable===!1&&(i.writable=!0,i.configurable=!0),(i.get||i.set)&&(e[s]={configurable:!0,writable:!0,enumerable:i.enumerable,value:n[s]})}return Object.create(Object.getPrototypeOf(n),e)}function qe(n,e){return e===void 0&&(e=!1),Je(n)||ne(n)||!K(n)||(z(n)>1&&(n.set=n.add=n.clear=n.delete=ln),Object.freeze(n),e&&ce(n,function(t,o){return qe(o,!0)},!0)),n}function ln(){I(2)}function Je(n){return n==null||typeof n!="object"||Object.isFrozen(n)}function H(n){var e=We[n];return e||I(18,n),e}function hn(n,e){We[n]||(We[n]=e)}function dt(){return _e}function xe(n,e){e&&(H("Patches"),n.u=[],n.s=[],n.v=e)}function Ce(n){He(n),n.p.forEach(fn),n.p=null}function He(n){n===_e&&(_e=n.l)}function lt(n){return _e={p:[],l:_e,h:n,m:!0,_:0}}function fn(n){var e=n[P];e.i===0||e.i===1?e.j():e.g=!0}function Pe(n,e){e._=e.p.length;var t=e.p[0],o=n!==void 0&&n!==t;return e.h.O||H("ES5").S(e,n,o),o?(t[P].P&&(Ce(e),I(4)),K(n)&&(n=Re(e,n),e.l||Se(e,n)),e.u&&H("Patches").M(t[P].t,n,e.u,e.s)):n=Re(e,t,[]),Ce(e),e.u&&e.v(e.u,e.s),n!==et?n:void 0}function Re(n,e,t){if(Je(e))return e;var o=e[P];if(!o)return ce(e,function(d,l){return ht(n,o,e,d,l,t)},!0),e;if(o.A!==n)return e;if(!o.P)return Se(n,o.t,!0),o.t;if(!o.I){o.I=!0,o.A._--;var s=o.i===4||o.i===5?o.o=Xe(o.k):o.o,i=s,r=!1;o.i===3&&(i=new Set(s),s.clear(),r=!0),ce(i,function(d,l){return ht(n,o,s,d,l,t,r)}),Se(n,s,!1),t&&n.u&&H("Patches").N(o,t,n.u,n.s)}return o.o}function ht(n,e,t,o,s,i,r){if(ne(s)){var d=Re(n,s,i&&e&&e.i!==3&&!me(e.R,o)?i.concat(o):void 0);if(Gt(t,o,d),!ne(d))return;n.m=!1}else r&&t.add(s);if(K(s)&&!Je(s)){if(!n.h.D&&n._<1)return;Re(n,s),e&&e.A.l||Se(n,s)}}function Se(n,e,t){t===void 0&&(t=!1),!n.l&&n.h.D&&n.m&&qe(e,t)}function Ge(n,e){var t=n[P];return(t?Q(t):n)[e]}function ft(n,e){if(e in n)for(var t=Object.getPrototypeOf(n);t;){var o=Object.getOwnPropertyDescriptor(t,e);if(o)return o;t=Object.getPrototypeOf(t)}}function Ye(n){n.P||(n.P=!0,n.l&&Ye(n.l))}function ke(n){n.o||(n.o=Xe(n.t))}function je(n,e,t){var o=Ie(e)?H("MapSet").F(e,t):Me(e)?H("MapSet").T(e,t):n.O?function(s,i){var r=Array.isArray(s),d={i:r?1:0,A:i?i.A:dt(),P:!1,I:!1,R:{},l:i,t:s,k:null,o:null,j:null,C:!1},l=d,u=Fe;r&&(l=[d],u=le);var a=Proxy.revocable(l,u),c=a.revoke,v=a.proxy;return d.k=v,d.j=c,v}(e,t):H("ES5").J(e,t);return(t?t.A:dt()).p.push(o),o}function mn(n){return ne(n)||I(22,n),function e(t){if(!K(t))return t;var o,s=t[P],i=z(t);if(s){if(!s.P&&(s.i<4||!H("ES5").K(s)))return s.t;s.I=!0,o=mt(t,i),s.I=!1}else o=mt(t,i);return ce(o,function(r,d){s&&Be(s.t,r)===d||Gt(o,r,e(d))}),i===3?new Set(o):o}(n)}function mt(n,e){switch(e){case 2:return new Map(n);case 3:return Array.from(n)}return Xe(n)}function Qe(){function n(o){if(!K(o))return o;if(Array.isArray(o))return o.map(n);if(Ie(o))return new Map(Array.from(o.entries()).map(function(r){return[r[0],n(r[1])]}));if(Me(o))return new Set(Array.from(o).map(n));var s=Object.create(Object.getPrototypeOf(o));for(var i in o)s[i]=n(o[i]);return me(o,he)&&(s[he]=o[he]),s}function e(o){return ne(o)?n(o):o}var t="add";hn("Patches",{$:function(o,s){return s.forEach(function(i){for(var r=i.path,d=i.op,l=o,u=0;u<r.length-1;u++){var a=z(l),c=r[u];typeof c!="string"&&typeof c!="number"&&(c=""+c),a!==0&&a!==1||c!=="__proto__"&&c!=="constructor"||I(24),typeof l=="function"&&c==="prototype"&&I(24),typeof(l=Be(l,c))!="object"&&I(15,r.join("/"))}var v=z(l),E=n(i.value),T=r[r.length-1];switch(d){case"replace":switch(v){case 2:return l.set(T,E);case 3:I(16);default:return l[T]=E}case t:switch(v){case 1:return T==="-"?l.push(E):l.splice(T,0,E);case 2:return l.set(T,E);case 3:return l.add(E);default:return l[T]=E}case"remove":switch(v){case 1:return l.splice(T,1);case 2:return l.delete(T);case 3:return l.delete(i.value);default:return delete l[T]}default:I(17,d)}}),o},N:function(o,s,i,r){switch(o.i){case 0:case 4:case 2:return function(d,l,u,a){var c=d.t,v=d.o;ce(d.R,function(E,T){var B=Be(c,E),M=Be(v,E),h=T?me(c,E)?"replace":t:"remove";if(B!==M||h!=="replace"){var f=l.concat(E);u.push(h==="remove"?{op:h,path:f}:{op:h,path:f,value:M}),a.push(h===t?{op:"remove",path:f}:h==="remove"?{op:t,path:f,value:e(B)}:{op:"replace",path:f,value:e(B)})}})}(o,s,i,r);case 5:case 1:return function(d,l,u,a){var c=d.t,v=d.R,E=d.o;if(E.length<c.length){var T=[E,c];c=T[0],E=T[1];var B=[a,u];u=B[0],a=B[1]}for(var M=0;M<c.length;M++)if(v[M]&&E[M]!==c[M]){var h=l.concat([M]);u.push({op:"replace",path:h,value:e(E[M])}),a.push({op:"replace",path:h,value:e(c[M])})}for(var f=c.length;f<E.length;f++){var m=l.concat([f]);u.push({op:t,path:m,value:e(E[f])})}c.length<E.length&&a.push({op:"replace",path:l.concat(["length"]),value:c.length})}(o,s,i,r);case 3:return function(d,l,u,a){var c=d.t,v=d.o,E=0;c.forEach(function(T){if(!v.has(T)){var B=l.concat([E]);u.push({op:"remove",path:B,value:T}),a.unshift({op:t,path:B,value:T})}E++}),E=0,v.forEach(function(T){if(!c.has(T)){var B=l.concat([E]);u.push({op:t,path:B,value:T}),a.unshift({op:"remove",path:B,value:T})}E++})}(o,s,i,r)}},M:function(o,s,i,r){i.push({op:"replace",path:[],value:s===et?void 0:s}),r.push({op:"replace",path:[],value:o})}})}var _t,_e,Ze=typeof Symbol<"u"&&typeof Symbol("x")=="symbol",_n=typeof Map<"u",yn=typeof Set<"u",yt=typeof Proxy<"u"&&Proxy.revocable!==void 0&&typeof Reflect<"u",et=Ze?Symbol.for("immer-nothing"):((_t={})["immer-nothing"]=!0,_t),he=Ze?Symbol.for("immer-draftable"):"__$immer_draftable",P=Ze?Symbol.for("immer-state"):"__$immer_state",En=""+Object.prototype.constructor,tt=typeof Reflect<"u"&&Reflect.ownKeys?Reflect.ownKeys:Object.getOwnPropertySymbols!==void 0?function(n){return Object.getOwnPropertyNames(n).concat(Object.getOwnPropertySymbols(n))}:Object.getOwnPropertyNames,pn=Object.getOwnPropertyDescriptors||function(n){var e={};return tt(n).forEach(function(t){e[t]=Object.getOwnPropertyDescriptor(n,t)}),e},We={},Fe={get:function(n,e){if(e===P)return n;var t=Q(n);if(!me(t,e))return function(s,i,r){var d,l=ft(i,r);return l?"value"in l?l.value:(d=l.get)===null||d===void 0?void 0:d.call(s.k):void 0}(n,t,e);var o=t[e];return n.I||!K(o)?o:o===Ge(n.t,e)?(ke(n),n.o[e]=je(n.A.h,o,n)):o},has:function(n,e){return e in Q(n)},ownKeys:function(n){return Reflect.ownKeys(Q(n))},set:function(n,e,t){var o=ft(Q(n),e);if(o!=null&&o.set)return o.set.call(n.k,t),!0;if(!n.P){var s=Ge(Q(n),e),i=s==null?void 0:s[P];if(i&&i.t===t)return n.o[e]=t,n.R[e]=!1,!0;if(dn(t,s)&&(t!==void 0||me(n.t,e)))return!0;ke(n),Ye(n)}return n.o[e]===t&&(t!==void 0||e in n.o)||Number.isNaN(t)&&Number.isNaN(n.o[e])||(n.o[e]=t,n.R[e]=!0),!0},deleteProperty:function(n,e){return Ge(n.t,e)!==void 0||e in n.t?(n.R[e]=!1,ke(n),Ye(n)):delete n.R[e],n.o&&delete n.o[e],!0},getOwnPropertyDescriptor:function(n,e){var t=Q(n),o=Reflect.getOwnPropertyDescriptor(t,e);return o&&{writable:!0,configurable:n.i!==1||e!=="length",enumerable:o.enumerable,value:t[e]}},defineProperty:function(){I(11)},getPrototypeOf:function(n){return Object.getPrototypeOf(n.t)},setPrototypeOf:function(){I(12)}},le={};ce(Fe,function(n,e){le[n]=function(){return arguments[0]=arguments[0][0],e.apply(this,arguments)}}),le.deleteProperty=function(n,e){return le.set.call(this,n,e,void 0)},le.set=function(n,e,t){return Fe.set.call(this,n[0],e,t,n[0])};var vn=function(){function n(t){var o=this;this.O=yt,this.D=!0,this.produce=function(s,i,r){if(typeof s=="function"&&typeof i!="function"){var d=i;i=s;var l=o;return function(B){var M=this;B===void 0&&(B=d);for(var h=arguments.length,f=Array(h>1?h-1:0),m=1;m<h;m++)f[m-1]=arguments[m];return l.produce(B,function(_){var y;return(y=i).call.apply(y,[M,_].concat(f))})}}var u;if(typeof i!="function"&&I(6),r!==void 0&&typeof r!="function"&&I(7),K(s)){var a=lt(o),c=je(o,s,void 0),v=!0;try{u=i(c),v=!1}finally{v?Ce(a):He(a)}return typeof Promise<"u"&&u instanceof Promise?u.then(function(B){return xe(a,r),Pe(B,a)},function(B){throw Ce(a),B}):(xe(a,r),Pe(u,a))}if(!s||typeof s!="object"){if((u=i(s))===void 0&&(u=s),u===et&&(u=void 0),o.D&&qe(u,!0),r){var E=[],T=[];H("Patches").M(s,u,E,T),r(E,T)}return u}I(21,s)},this.produceWithPatches=function(s,i){if(typeof s=="function")return function(u){for(var a=arguments.length,c=Array(a>1?a-1:0),v=1;v<a;v++)c[v-1]=arguments[v];return o.produceWithPatches(u,function(E){return s.apply(void 0,[E].concat(c))})};var r,d,l=o.produce(s,i,function(u,a){r=u,d=a});return typeof Promise<"u"&&l instanceof Promise?l.then(function(u){return[u,r,d]}):[l,r,d]},typeof(t==null?void 0:t.useProxies)=="boolean"&&this.setUseProxies(t.useProxies),typeof(t==null?void 0:t.autoFreeze)=="boolean"&&this.setAutoFreeze(t.autoFreeze)}var e=n.prototype;return e.createDraft=function(t){K(t)||I(8),ne(t)&&(t=mn(t));var o=lt(this),s=je(this,t,void 0);return s[P].C=!0,He(o),s},e.finishDraft=function(t,o){var s=t&&t[P],i=s.A;return xe(i,o),Pe(void 0,i)},e.setAutoFreeze=function(t){this.D=t},e.setUseProxies=function(t){t&&!yt&&I(20),this.O=t},e.applyPatches=function(t,o){var s;for(s=o.length-1;s>=0;s--){var i=o[s];if(i.path.length===0&&i.op==="replace"){t=i.value;break}}s>-1&&(o=o.slice(s+1));var r=H("Patches").$;return ne(t)?r(t,o):this.produce(t,function(d){return r(d,o)})},n}(),G=new vn;G.produce;var nt=G.produceWithPatches.bind(G);G.setAutoFreeze.bind(G);G.setUseProxies.bind(G);G.applyPatches.bind(G);G.createDraft.bind(G);G.finishDraft.bind(G);var ie=function(n,e,t,o){function s(i){return i instanceof t?i:new t(function(r){r(i)})}return new(t||(t=Promise))(function(i,r){function d(a){try{u(o.next(a))}catch(c){r(c)}}function l(a){try{u(o.throw(a))}catch(c){r(c)}}function u(a){a.done?i(a.value):s(a.value).then(d,l)}u((o=o.apply(n,e||[])).next())})};Qe();class On{constructor(e){this.messageBus=e}getItems(e){return ie(this,void 0,void 0,function*(){if(Array.isArray(e)){const{items:t}=yield this.messageBus.sendAsync("OBR_SCENE_ITEMS_GET_ITEMS",{ids:e});return t}else if(e){const{items:t}=yield this.messageBus.sendAsync("OBR_SCENE_ITEMS_GET_ALL_ITEMS",{});return t.filter(e)}else{const{items:t}=yield this.messageBus.sendAsync("OBR_SCENE_ITEMS_GET_ALL_ITEMS",{});return t}})}isItemArray(e){return Array.isArray(e)&&e.every(t=>typeof t!="string")}updateItems(e,t,o=!0){return ie(this,void 0,void 0,function*(){let s;this.isItemArray(e)?s=e:s=yield this.getItems(e);const[i,r]=nt(s,t),d=i.map(l=>({id:l.id,type:l.type}));for(const l of r){const[u,a]=l.path;typeof u=="number"&&typeof a=="string"&&(d[u][a]=i[u][a])}yield this.messageBus.sendAsync("OBR_SCENE_ITEMS_UPDATE_ITEMS",{updates:d,updateAttachments:o})})}addItems(e){return ie(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_SCENE_ITEMS_ADD_ITEMS",{items:e})})}deleteItems(e){return ie(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_SCENE_ITEMS_DELETE_ITEMS",{ids:e})})}getItemAttachments(e){return ie(this,void 0,void 0,function*(){const{items:t}=yield this.messageBus.sendAsync("OBR_SCENE_ITEMS_GET_ITEM_ATTACHMENTS",{ids:e});return t})}getItemBounds(e){return ie(this,void 0,void 0,function*(){const{bounds:t}=yield this.messageBus.sendAsync("OBR_SCENE_ITEMS_GET_ITEM_BOUNDS",{ids:e});return t})}onChange(e){const t=o=>{e(o.items)};return this.messageBus.send("OBR_SCENE_ITEMS_SUBSCRIBE",{}),this.messageBus.on("OBR_SCENE_ITEMS_EVENT_CHANGE",t),()=>{this.messageBus.send("OBR_SCENE_ITEMS_UNSUBSCRIBE",{}),this.messageBus.off("OBR_SCENE_ITEMS_EVENT_CHANGE",t)}}}var re=function(n,e,t,o){function s(i){return i instanceof t?i:new t(function(r){r(i)})}return new(t||(t=Promise))(function(i,r){function d(a){try{u(o.next(a))}catch(c){r(c)}}function l(a){try{u(o.throw(a))}catch(c){r(c)}}function u(a){a.done?i(a.value):s(a.value).then(d,l)}u((o=o.apply(n,e||[])).next())})};Qe();class gn{constructor(e){this.messageBus=e}getItems(e){return re(this,void 0,void 0,function*(){if(Array.isArray(e)){const{items:t}=yield this.messageBus.sendAsync("OBR_SCENE_LOCAL_GET_ITEMS",{ids:e});return t}else if(e){const{items:t}=yield this.messageBus.sendAsync("OBR_SCENE_LOCAL_GET_ALL_ITEMS",{});return t.filter(e)}else{const{items:t}=yield this.messageBus.sendAsync("OBR_SCENE_LOCAL_GET_ALL_ITEMS",{});return t}})}updateItems(e,t,o,s=!0){return re(this,void 0,void 0,function*(){const i=yield this.getItems(e),[r,d]=nt(i,t),l=r.map(u=>({id:u.id,type:u.type}));for(const u of d){const[a,c]=u.path;typeof a=="number"&&typeof c=="string"&&(l[a][c]=r[a][c])}yield this.messageBus.sendAsync("OBR_SCENE_LOCAL_UPDATE_ITEMS",{updates:l,fastUpdate:o,updateAttachments:s})})}addItems(e){return re(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_SCENE_LOCAL_ADD_ITEMS",{items:e})})}deleteItems(e){return re(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_SCENE_LOCAL_DELETE_ITEMS",{ids:e})})}getItemAttachments(e){return re(this,void 0,void 0,function*(){const{items:t}=yield this.messageBus.sendAsync("OBR_SCENE_LOCAL_GET_ITEM_ATTACHMENTS",{ids:e});return t})}getItemBounds(e){return re(this,void 0,void 0,function*(){const{bounds:t}=yield this.messageBus.sendAsync("OBR_SCENE_LOCAL_GET_ITEM_BOUNDS",{ids:e});return t})}onChange(e){const t=o=>{e(o.items)};return this.messageBus.send("OBR_SCENE_LOCAL_SUBSCRIBE",{}),this.messageBus.on("OBR_SCENE_LOCAL_EVENT_CHANGE",t),()=>{this.messageBus.send("OBR_SCENE_LOCAL_UNSUBSCRIBE",{}),this.messageBus.off("OBR_SCENE_LOCAL_EVENT_CHANGE",t)}}}var Ue=function(n,e,t,o){function s(i){return i instanceof t?i:new t(function(r){r(i)})}return new(t||(t=Promise))(function(i,r){function d(a){try{u(o.next(a))}catch(c){r(c)}}function l(a){try{u(o.throw(a))}catch(c){r(c)}}function u(a){a.done?i(a.value):s(a.value).then(d,l)}u((o=o.apply(n,e||[])).next())})};class Tn{constructor(e){this.messageBus=e,this.grid=new un(e),this.fog=new an(e),this.history=new cn(e),this.items=new On(e),this.local=new gn(e)}isReady(){return Ue(this,void 0,void 0,function*(){const{ready:e}=yield this.messageBus.sendAsync("OBR_SCENE_IS_READY",{});return e})}onReadyChange(e){const t=o=>{e(o.ready)};return this.messageBus.send("OBR_SCENE_READY_SUBSCRIBE",{}),this.messageBus.on("OBR_SCENE_EVENT_READY_CHANGE",t),()=>{this.messageBus.send("OBR_SCENE_READY_UNSUBSCRIBE",{}),this.messageBus.off("OBR_SCENE_EVENT_READY_CHANGE",t)}}getMetadata(){return Ue(this,void 0,void 0,function*(){const{metadata:e}=yield this.messageBus.sendAsync("OBR_SCENE_GET_METADATA",{});return e})}setMetadata(e){return Ue(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_SCENE_SET_METADATA",{update:e})})}onMetadataChange(e){const t=o=>{e(o.metadata)};return this.messageBus.send("OBR_SCENE_METADATA_SUBSCRIBE",{}),this.messageBus.on("OBR_SCENE_METADATA_EVENT_CHANGE",t),()=>{this.messageBus.send("OBR_SCENE_METADATA_UNSUBSCRIBE",{}),this.messageBus.off("OBR_SCENE_METADATA_EVENT_CHANGE",t)}}}function kt(n){return n.startsWith("http")?n:`${window.location.origin}${n}`}function fe(n){return n.map(e=>Object.assign(Object.assign({},e),{icon:kt(e.icon)}))}function ot(n){return Object.assign(Object.assign({},n),{url:kt(n.url)})}var Et=function(n,e,t,o){function s(i){return i instanceof t?i:new t(function(r){r(i)})}return new(t||(t=Promise))(function(i,r){function d(a){try{u(o.next(a))}catch(c){r(c)}}function l(a){try{u(o.throw(a))}catch(c){r(c)}}function u(a){a.done?i(a.value):s(a.value).then(d,l)}u((o=o.apply(n,e||[])).next())})};class Bn{constructor(e){this.contextMenus={},this.handleClick=t=>{var o;const s=this.contextMenus[t.id];s&&((o=s.onClick)===null||o===void 0||o.call(s,t.context,t.elementId))},this.messageBus=e,e.on("OBR_CONTEXT_MENU_EVENT_CLICK",this.handleClick)}create(e){return Et(this,void 0,void 0,function*(){this.messageBus.sendAsync("OBR_CONTEXT_MENU_CREATE",{id:e.id,shortcut:e.shortcut,icons:fe(e.icons),embed:e.embed&&ot(e.embed)}),this.contextMenus[e.id]=e})}remove(e){return Et(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_CONTEXT_MENU_REMOVE",{id:e}),delete this.contextMenus[e]})}}var $=function(n,e,t,o){function s(i){return i instanceof t?i:new t(function(r){r(i)})}return new(t||(t=Promise))(function(i,r){function d(a){try{u(o.next(a))}catch(c){r(c)}}function l(a){try{u(o.throw(a))}catch(c){r(c)}}function u(a){a.done?i(a.value):s(a.value).then(d,l)}u((o=o.apply(n,e||[])).next())})};class An{constructor(e){this.tools={},this.toolActions={},this.toolModes={},this.handleToolClick=t=>{const o=this.tools[t.id];if(o)if(o.onClick){const s=o.onClick(t.context,t.elementId);Promise.resolve(s).then(i=>{i&&this.messageBus.send("OBR_TOOL_ACTIVATE",{id:t.id})})}else this.messageBus.send("OBR_TOOL_ACTIVATE",{id:t.id})},this.handleToolActionClick=t=>{var o;const s=this.toolActions[t.id];s&&((o=s.onClick)===null||o===void 0||o.call(s,t.context,t.elementId))},this.handleToolModeClick=t=>{const o=this.toolModes[t.id];if(o)if(o.onClick){const s=o.onClick(t.context,t.elementId);Promise.resolve(s).then(i=>{i&&this.messageBus.send("OBR_TOOL_MODE_ACTIVATE",{toolId:t.context.activeTool,modeId:t.id})})}else this.messageBus.send("OBR_TOOL_MODE_ACTIVATE",{toolId:t.context.activeTool,modeId:t.id})},this.handleToolModeToolClick=t=>{const o=this.toolModes[t.id];if(o)if(o.onToolClick){const s=o.onToolClick(t.context,t.event);Promise.resolve(s).then(i=>{i&&t.event.target&&!t.event.target.locked&&this.messageBus.sendAsync("OBR_PLAYER_SELECT",{items:[t.event.target.id]})})}else t.event.target&&!t.event.target.locked&&this.messageBus.sendAsync("OBR_PLAYER_SELECT",{items:[t.event.target.id]})},this.handleToolModeToolDoubleClick=t=>{const o=this.toolModes[t.id];if(o)if(o.onToolDoubleClick){const s=o.onToolDoubleClick(t.context,t.event);Promise.resolve(s).then(i=>{i&&t.event.target&&this.messageBus.sendAsync("OBR_PLAYER_SELECT",{items:[t.event.target.id]})})}else t.event.target&&this.messageBus.sendAsync("OBR_PLAYER_SELECT",{items:[t.event.target.id]})},this.handleToolModeToolDown=t=>{var o;const s=this.toolModes[t.id];s&&((o=s.onToolDown)===null||o===void 0||o.call(s,t.context,t.event))},this.handleToolModeToolMove=t=>{var o;const s=this.toolModes[t.id];s&&((o=s.onToolMove)===null||o===void 0||o.call(s,t.context,t.event))},this.handleToolModeToolUp=t=>{var o;const s=this.toolModes[t.id];s&&((o=s.onToolUp)===null||o===void 0||o.call(s,t.context,t.event))},this.handleToolModeToolDragStart=t=>{var o;const s=this.toolModes[t.id];s&&((o=s.onToolDragStart)===null||o===void 0||o.call(s,t.context,t.event))},this.handleToolModeToolDragMove=t=>{var o;const s=this.toolModes[t.id];s&&((o=s.onToolDragMove)===null||o===void 0||o.call(s,t.context,t.event))},this.handleToolModeToolDragEnd=t=>{var o;const s=this.toolModes[t.id];s&&((o=s.onToolDragEnd)===null||o===void 0||o.call(s,t.context,t.event))},this.handleToolModeToolDragCancel=t=>{var o;const s=this.toolModes[t.id];s&&((o=s.onToolDragCancel)===null||o===void 0||o.call(s,t.context,t.event))},this.handleToolModeKeyDown=t=>{var o;const s=this.toolModes[t.id];s&&((o=s.onKeyDown)===null||o===void 0||o.call(s,t.context,t.event))},this.handleToolModeKeyUp=t=>{var o;const s=this.toolModes[t.id];s&&((o=s.onKeyUp)===null||o===void 0||o.call(s,t.context,t.event))},this.handleToolModeActivate=t=>{var o;const s=this.toolModes[t.id];s&&((o=s.onActivate)===null||o===void 0||o.call(s,t.context))},this.handleToolModeDeactivate=t=>{var o;const s=this.toolModes[t.id];s&&((o=s.onDeactivate)===null||o===void 0||o.call(s,t.context))},this.messageBus=e,e.on("OBR_TOOL_EVENT_CLICK",this.handleToolClick),e.on("OBR_TOOL_ACTION_EVENT_CLICK",this.handleToolActionClick),e.on("OBR_TOOL_MODE_EVENT_CLICK",this.handleToolModeClick),e.on("OBR_TOOL_MODE_EVENT_TOOL_CLICK",this.handleToolModeToolClick),e.on("OBR_TOOL_MODE_EVENT_TOOL_DOUBLE_CLICK",this.handleToolModeToolDoubleClick),e.on("OBR_TOOL_MODE_EVENT_TOOL_DOWN",this.handleToolModeToolDown),e.on("OBR_TOOL_MODE_EVENT_TOOL_MOVE",this.handleToolModeToolMove),e.on("OBR_TOOL_MODE_EVENT_TOOL_UP",this.handleToolModeToolUp),e.on("OBR_TOOL_MODE_EVENT_TOOL_DRAG_START",this.handleToolModeToolDragStart),e.on("OBR_TOOL_MODE_EVENT_TOOL_DRAG_MOVE",this.handleToolModeToolDragMove),e.on("OBR_TOOL_MODE_EVENT_TOOL_DRAG_END",this.handleToolModeToolDragEnd),e.on("OBR_TOOL_MODE_EVENT_TOOL_DRAG_CANCEL",this.handleToolModeToolDragCancel),e.on("OBR_TOOL_MODE_EVENT_KEY_DOWN",this.handleToolModeKeyDown),e.on("OBR_TOOL_MODE_EVENT_KEY_UP",this.handleToolModeKeyUp),e.on("OBR_TOOL_MODE_EVENT_ACTIVATE",this.handleToolModeActivate),e.on("OBR_TOOL_MODE_EVENT_DEACTIVATE",this.handleToolModeDeactivate)}create(e){return $(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_TOOL_CREATE",{id:e.id,shortcut:e.shortcut,defaultMode:e.defaultMode,defaultMetadata:e.defaultMetadata,icons:fe(e.icons),disabled:e.disabled}),this.tools[e.id]=e})}remove(e){return $(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_TOOL_REMOVE",{id:e}),delete this.tools[e]})}activateTool(e){return $(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_TOOL_ACTIVATE",{id:e})})}getMetadata(e){return $(this,void 0,void 0,function*(){const{metadata:t}=yield this.messageBus.sendAsync("OBR_TOOL_GET_METADATA",{id:e});return t})}setMetadata(e,t){return $(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_TOOL_SET_METADATA",{toolId:e,update:t})})}createAction(e){return $(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_TOOL_ACTION_CREATE",{id:e.id,shortcut:e.shortcut,icons:fe(e.icons),disabled:e.disabled}),this.toolActions[e.id]=e})}removeAction(e){return $(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_TOOL_ACTION_REMOVE",{id:e}),delete this.tools[e]})}createMode(e){return $(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_TOOL_MODE_CREATE",{id:e.id,shortcut:e.shortcut,icons:fe(e.icons),preventDrag:e.preventDrag,disabled:e.disabled,cursors:e.cursors}),this.toolModes[e.id]=e})}removeMode(e){return $(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_TOOL_MODE_REMOVE",{id:e}),delete this.tools[e]})}activateMode(e,t){return $(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_TOOL_MODE_ACTIVATE",{toolId:e,modeId:t})})}}var ae=function(n,e,t,o){function s(i){return i instanceof t?i:new t(function(r){r(i)})}return new(t||(t=Promise))(function(i,r){function d(a){try{u(o.next(a))}catch(c){r(c)}}function l(a){try{u(o.throw(a))}catch(c){r(c)}}function u(a){a.done?i(a.value):s(a.value).then(d,l)}u((o=o.apply(n,e||[])).next())})};class Cn{constructor(e){this.messageBus=e}open(e){return ae(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_POPOVER_OPEN",Object.assign({},ot(e)))})}close(e){return ae(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_POPOVER_CLOSE",{id:e})})}getWidth(e){return ae(this,void 0,void 0,function*(){const{width:t}=yield this.messageBus.sendAsync("OBR_POPOVER_GET_WIDTH",{id:e});return t})}setWidth(e,t){return ae(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_POPOVER_SET_WIDTH",{id:e,width:t})})}getHeight(e){return ae(this,void 0,void 0,function*(){const{height:t}=yield this.messageBus.sendAsync("OBR_POPOVER_GET_HEIGHT",{id:e});return t})}setHeight(e,t){return ae(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_POPOVER_SET_HEIGHT",{id:e,height:t})})}}var pt=function(n,e,t,o){function s(i){return i instanceof t?i:new t(function(r){r(i)})}return new(t||(t=Promise))(function(i,r){function d(a){try{u(o.next(a))}catch(c){r(c)}}function l(a){try{u(o.throw(a))}catch(c){r(c)}}function u(a){a.done?i(a.value):s(a.value).then(d,l)}u((o=o.apply(n,e||[])).next())})};class Rn{constructor(e){this.messageBus=e}open(e){return pt(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_MODAL_OPEN",Object.assign({},ot(e)))})}close(e){return pt(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_MODAL_CLOSE",{id:e})})}}var L=function(n,e,t,o){function s(i){return i instanceof t?i:new t(function(r){r(i)})}return new(t||(t=Promise))(function(i,r){function d(a){try{u(o.next(a))}catch(c){r(c)}}function l(a){try{u(o.throw(a))}catch(c){r(c)}}function u(a){a.done?i(a.value):s(a.value).then(d,l)}u((o=o.apply(n,e||[])).next())})};class Sn{constructor(e){this.messageBus=e}getWidth(){return L(this,void 0,void 0,function*(){const{width:e}=yield this.messageBus.sendAsync("OBR_ACTION_GET_WIDTH",{});return e})}setWidth(e){return L(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_ACTION_SET_WIDTH",{width:e})})}getHeight(){return L(this,void 0,void 0,function*(){const{height:e}=yield this.messageBus.sendAsync("OBR_ACTION_GET_HEIGHT",{});return e})}setHeight(e){return L(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_ACTION_SET_HEIGHT",{height:e})})}getBadgeText(){return L(this,void 0,void 0,function*(){const{badgeText:e}=yield this.messageBus.sendAsync("OBR_ACTION_GET_BADGE_TEXT",{});return e})}setBadgeText(e){return L(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_ACTION_SET_BADGE_TEXT",{badgeText:e})})}getBadgeBackgroundColor(){return L(this,void 0,void 0,function*(){const{badgeBackgroundColor:e}=yield this.messageBus.sendAsync("OBR_ACTION_GET_BADGE_BACKGROUND_COLOR",{});return e})}setBadgeBackgroundColor(e){return L(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_ACTION_SET_BADGE_BACKGROUND_COLOR",{badgeBackgroundColor:e})})}getIcon(){return L(this,void 0,void 0,function*(){const{icon:e}=yield this.messageBus.sendAsync("OBR_ACTION_GET_ICON",{});return e})}setIcon(e){return L(this,void 0,void 0,function*(){const t=fe([{icon:e}]);yield this.messageBus.sendAsync("OBR_ACTION_SET_ICON",{icon:t[0].icon})})}getTitle(){return L(this,void 0,void 0,function*(){const{title:e}=yield this.messageBus.sendAsync("OBR_ACTION_GET_TITLE",{});return e})}setTitle(e){return L(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_ACTION_SET_TITLE",{title:e})})}isOpen(){return L(this,void 0,void 0,function*(){const{isOpen:e}=yield this.messageBus.sendAsync("OBR_ACTION_GET_IS_OPEN",{});return e})}open(){return L(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_ACTION_OPEN",{})})}close(){return L(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_ACTION_CLOSE",{})})}onOpenChange(e){const t=o=>{e(o.isOpen)};return this.messageBus.send("OBR_ACTION_IS_OPEN_SUBSCRIBE",{}),this.messageBus.on("OBR_ACTION_IS_OPEN_EVENT_CHANGE",t),()=>{this.messageBus.send("OBR_IS_OPEN_ACTION_UNSUBSCRIBE",{}),this.messageBus.off("OBR_ACTION_IS_OPEN_EVENT_CHANGE",t)}}}var Nn=function(n,e,t,o){function s(i){return i instanceof t?i:new t(function(r){r(i)})}return new(t||(t=Promise))(function(i,r){function d(a){try{u(o.next(a))}catch(c){r(c)}}function l(a){try{u(o.throw(a))}catch(c){r(c)}}function u(a){a.done?i(a.value):s(a.value).then(d,l)}u((o=o.apply(n,e||[])).next())})};Qe();class In{constructor(e){this.messageBus=e}startItemInteraction(e,t=!0){return Nn(this,void 0,void 0,function*(){const{id:o}=yield this.messageBus.sendAsync("OBR_INTERACTION_START_ITEM_INTERACTION",{baseState:e,updateAttachments:t});let s=e;return[d=>{const[l,u]=nt(s,d);return s=l,this.messageBus.send("OBR_INTERACTION_UPDATE_ITEM_INTERACTION",{id:o,patches:u}),l},()=>{this.messageBus.send("OBR_INTERACTION_STOP_ITEM_INTERACTION",{id:o})}]})}}var Mn=function(n,e,t,o){function s(i){return i instanceof t?i:new t(function(r){r(i)})}return new(t||(t=Promise))(function(i,r){function d(a){try{u(o.next(a))}catch(c){r(c)}}function l(a){try{u(o.throw(a))}catch(c){r(c)}}function u(a){a.done?i(a.value):s(a.value).then(d,l)}u((o=o.apply(n,e||[])).next())})};class bn{constructor(e){this.messageBus=e}getPlayers(){return Mn(this,void 0,void 0,function*(){const{players:e}=yield this.messageBus.sendAsync("OBR_PARTY_GET_PLAYERS",{});return e})}onChange(e){const t=o=>{e(o.players)};return this.messageBus.send("OBR_PARTY_SUBSCRIBE",{}),this.messageBus.on("OBR_PARTY_EVENT_CHANGE",t),()=>{this.messageBus.send("OBR_PARTY_UNSUBSCRIBE",{}),this.messageBus.off("OBR_PARTY_EVENT_CHANGE",t)}}}var $e=function(n,e,t,o){function s(i){return i instanceof t?i:new t(function(r){r(i)})}return new(t||(t=Promise))(function(i,r){function d(a){try{u(o.next(a))}catch(c){r(c)}}function l(a){try{u(o.throw(a))}catch(c){r(c)}}function u(a){a.done?i(a.value):s(a.value).then(d,l)}u((o=o.apply(n,e||[])).next())})};class wn{constructor(e){this.messageBus=e}get id(){return this.messageBus.roomId}getPermissions(){return $e(this,void 0,void 0,function*(){const{permissions:e}=yield this.messageBus.sendAsync("OBR_ROOM_GET_PERMISSIONS",{});return e})}getMetadata(){return $e(this,void 0,void 0,function*(){const{metadata:e}=yield this.messageBus.sendAsync("OBR_ROOM_GET_METADATA",{});return e})}setMetadata(e){return $e(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_ROOM_SET_METADATA",{update:e})})}onMetadataChange(e){const t=o=>{e(o.metadata)};return this.messageBus.send("OBR_ROOM_METADATA_SUBSCRIBE",{}),this.messageBus.on("OBR_ROOM_METADATA_EVENT_CHANGE",t),()=>{this.messageBus.send("OBR_METADATA_ROOM_UNSUBSCRIBE",{}),this.messageBus.off("OBR_ROOM_METADATA_EVENT_CHANGE",t)}}onPermissionsChange(e){const t=o=>{e(o.permissions)};return this.messageBus.send("OBR_ROOM_PERMISSIONS_SUBSCRIBE",{}),this.messageBus.on("OBR_ROOM_PERMISSIONS_EVENT_CHANGE",t),()=>{this.messageBus.send("OBR_PERMISSIONS_ROOM_UNSUBSCRIBE",{}),this.messageBus.off("OBR_ROOM_PERMISSIONS_EVENT_CHANGE",t)}}}var Ln=function(n,e,t,o){function s(i){return i instanceof t?i:new t(function(r){r(i)})}return new(t||(t=Promise))(function(i,r){function d(a){try{u(o.next(a))}catch(c){r(c)}}function l(a){try{u(o.throw(a))}catch(c){r(c)}}function u(a){a.done?i(a.value):s(a.value).then(d,l)}u((o=o.apply(n,e||[])).next())})};class Dn{constructor(e){this.messageBus=e}getTheme(){return Ln(this,void 0,void 0,function*(){const{theme:e}=yield this.messageBus.sendAsync("OBR_THEME_GET_THEME",{});return e})}onChange(e){const t=o=>{e(o.theme)};return this.messageBus.send("OBR_THEME_SUBSCRIBE",{}),this.messageBus.on("OBR_THEME_EVENT_CHANGE",t),()=>{this.messageBus.send("OBR_THEME_UNSUBSCRIBE",{}),this.messageBus.off("OBR_THEME_EVENT_CHANGE",t)}}}var vt=function(n,e,t,o){function s(i){return i instanceof t?i:new t(function(r){r(i)})}return new(t||(t=Promise))(function(i,r){function d(a){try{u(o.next(a))}catch(c){r(c)}}function l(a){try{u(o.throw(a))}catch(c){r(c)}}function u(a){a.done?i(a.value):s(a.value).then(d,l)}u((o=o.apply(n,e||[])).next())})};class xn{constructor(e){this.messageBus=e}uploadImages(e){return vt(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_ASSETS_UPLOAD_IMAGES",{images:e})})}uploadScenes(e){return vt(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_ASSETS_UPLOAD_SCENES",{scenes:e})})}}const Pn=typeof atob=="function",st=typeof Buffer=="function",Ot=typeof TextDecoder=="function"?new TextDecoder:void 0;typeof TextEncoder=="function"&&new TextEncoder;const Gn="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",kn=Array.prototype.slice.call(Gn),Oe=(n=>{let e={};return n.forEach((t,o)=>e[t]=o),e})(kn),Un=/^(?:[A-Za-z\d+\/]{4})*?(?:[A-Za-z\d+\/]{2}(?:==)?|[A-Za-z\d+\/]{3}=?)?$/,Z=String.fromCharCode.bind(String),gt=typeof Uint8Array.from=="function"?Uint8Array.from.bind(Uint8Array):n=>new Uint8Array(Array.prototype.slice.call(n,0)),Ut=n=>n.replace(/[^A-Za-z0-9\+\/]/g,""),$n=/[\xC0-\xDF][\x80-\xBF]|[\xE0-\xEF][\x80-\xBF]{2}|[\xF0-\xF7][\x80-\xBF]{3}/g,Vn=n=>{switch(n.length){case 4:var e=(7&n.charCodeAt(0))<<18|(63&n.charCodeAt(1))<<12|(63&n.charCodeAt(2))<<6|63&n.charCodeAt(3),t=e-65536;return Z((t>>>10)+55296)+Z((t&1023)+56320);case 3:return Z((15&n.charCodeAt(0))<<12|(63&n.charCodeAt(1))<<6|63&n.charCodeAt(2));default:return Z((31&n.charCodeAt(0))<<6|63&n.charCodeAt(1))}},Hn=n=>n.replace($n,Vn),Yn=n=>{if(n=n.replace(/\s+/g,""),!Un.test(n))throw new TypeError("malformed base64.");n+="==".slice(2-(n.length&3));let e,t="",o,s;for(let i=0;i<n.length;)e=Oe[n.charAt(i++)]<<18|Oe[n.charAt(i++)]<<12|(o=Oe[n.charAt(i++)])<<6|(s=Oe[n.charAt(i++)]),t+=o===64?Z(e>>16&255):s===64?Z(e>>16&255,e>>8&255):Z(e>>16&255,e>>8&255,e&255);return t},$t=Pn?n=>atob(Ut(n)):st?n=>Buffer.from(n,"base64").toString("binary"):Yn,jn=st?n=>gt(Buffer.from(n,"base64")):n=>gt($t(n).split("").map(e=>e.charCodeAt(0))),Wn=st?n=>Buffer.from(n,"base64").toString("utf8"):Ot?n=>Ot.decode(jn(n)):n=>Hn($t(n)),Fn=n=>Ut(n.replace(/[-_]/g,e=>e=="-"?"+":"/")),Kn=n=>Wn(Fn(n));function zn(){const e=new URLSearchParams(window.location.search).get("obrref");let t="",o="";if(e){const i=Kn(e).split(" ");i.length===2&&(t=i[0],o=i[1])}return{origin:t,roomId:o}}var Tt;(function(n){n[n.MOVE=0]="MOVE",n[n.LINE=1]="LINE",n[n.QUAD=2]="QUAD",n[n.CONIC=3]="CONIC",n[n.CUBIC=4]="CUBIC",n[n.CLOSE=5]="CLOSE"})(Tt||(Tt={}));const Ke=zn(),N=new sn(Ke.origin,Ke.roomId),Xn=new jt(N),qn=new Yt(N),Jn=new bn(N),Qn=new rn(N),Zn=new Tn(N),eo=new Bn(N),to=new An(N),no=new Cn(N),oo=new Rn(N),so=new Sn(N),io=new In(N),ro=new wn(N),ao=new Dn(N),uo=new xn(N),q={onReady:n=>{N.ready?n():N.once("OBR_READY",()=>n())},get isReady(){return N.ready},viewport:Xn,player:qn,party:Jn,notification:Qn,scene:Zn,contextMenu:eo,tool:to,popover:no,modal:oo,action:so,interaction:io,room:ro,theme:ao,assets:uo,isAvailable:!!Ke.origin};function co(n){let e=0;if(n.length===0)return e;for(let t=0;t<n.length;t++){const o=n.charCodeAt(t);e=(e<<5)-e+o,e&=e}return e}function lo(n){return`hsl(${(co(n)%360+360)%360}, 70%, 60%)`}function Bt(n,e){const t=window.matchMedia("(prefers-color-scheme: dark)"),o=t.matches?"dark":"light",s=t.matches?"light":"dark";for(var i=0;i<e.styleSheets.length;i++)for(var r=0;r<e.styleSheets[i].cssRules.length;r++){let d=e.styleSheets[i].cssRules[r];d&&d.media&&d.media.mediaText.includes("prefers-color-scheme")&&(n.mode=="LIGHT"?(d.media.appendMedium(`(prefers-color-scheme: ${o})`),d.media.mediaText.includes(s)&&d.media.deleteMedium(`(prefers-color-scheme: ${s})`)):n.mode=="DARK"&&(d.media.appendMedium(`(prefers-color-scheme: ${s})`),d.media.mediaText.includes(o)&&d.media.deleteMedium(`(prefers-color-scheme: ${o})`)))}}class Ae{}it(Ae,"EXTENSIONID","com.battle-system.calendar");document.querySelector("#app").innerHTML=`
<div id="floating-header">
  <button id="calendarButton" class="button-selected" (click)="toggleContent('calendar')">Calendar</button>
  <button (click)="toggleContent('months')">Months</button>
  <button (click)="toggleContent('days')">Days</button>
  <button (click)="toggleContent('moons')">Moons</button>
  <button (click)="toggleContent('import')">Import</button>
  <button id="generateCalendar">Generate</button>
</div>

<div id="calendar" class="content">
    <h2 id="titleLine"><div id="spellLevelContainer" style="display:none;"></div><div id="titleName">Calendar!</div><div id="profLevelContainer" style="display:none;"></div></h2>
    <div id="moonContainer"></div>
    <div id="calendarOutput"></div>
</div>

<div id="months" class="content" style="display:none;">
    <label for="calendarName">Calendar Name/Year:</label>
    <input type="text" id="calendarName" name="calendarName" value="Testers">
    </br>
    <label for="currentMonth">Current Month:</label>
    <input type="number" class="input-mini" id="currentMonth" name="currentMonth" value="1">
    </br>
    <label for="numMonths">Number of Months:</label>
    <input type="number" class="input-mini" id="numMonths" name="numMonths" min="1" value="12">
    <div id="monthInputContainer"></div>
</div>

<div id="days" class="content" style="display:none;">
    <label for="currentDay">Current Day:</label>
    <input type="number" class="input-mini" id="currentDay" name="currentDay" value="1">
    </br>
    <label for="daysPerWeek">Days per Week:</label>
    <input type="number" class="input-mini" id="daysPerWeek" name="daysPerWeek" min="1" value="7">
    <div id="dayNameInputContainer"></div>
        
    <label for="totalDaysInYear">Total Days in Year:</label>
    <input type="number" class="input-mini" id="totalDaysInYear" name="totalDaysInYear" min="1" value="365">
</div>

<div id="moons" class="content" style="display:none;">
    <label for="numMoons">Number of Moons:</label>
    <input type="number" class="input-mini" id="numMoons" name="numMoons" min="1" value="1">
    <div id="moonInputContainer"></div>
</div>

<div id="import" class="content" style="display:none;">
    <label for="donjonJson">DonJon Calendar Importer:</label>
    </br>
    <textarea id="donjonJson" rows="20" style="width: 100%;"></textarea>
    </br>
    <button id="importDonJon">Import DonJon Calendar</button>
</div>
`;const Ve=document.getElementById("calendarName"),J=document.getElementById("daysPerWeek"),At=document.getElementById("monthInputContainer"),V=document.getElementById("numMonths"),Ct=document.getElementById("dayNameInputContainer"),Rt=document.getElementById("moonInputContainer"),de=document.getElementById("numMoons"),ho=document.getElementById("generateCalendar"),fo=document.getElementById("importDonJon"),St=document.getElementById("calendarOutput"),mo=document.getElementById("calendarButton"),_o=document.getElementById("generateCalendar"),ge=document.getElementById("titleName"),ee=document.getElementById("spellLevelContainer"),be=document.createElement("div");let j=0;be.textContent="SpellLevel: ";be.classList.add("moon-phase-label");be.style.marginTop="4px";ee==null||ee.appendChild(be);const ye=document.createElement("input");ye.id="spellInput";ye.type="number";ye.classList.add("moon-mage-stuff");ye.onchange=n=>{switch(+n.target.value){case 0:j=0;break;case 1:j=0;break;case 2:j=2;break;case 3:j=4;break;case 4:j=6;break;case 5:j=8;break;default:j=8;break}const o=document.querySelectorAll(".moon-dc-label");for(const s of o){const i=+s.getAttribute("data-dc");s.textContent=`Spell DC: ${(i+j).toString()}`}};ee==null||ee.appendChild(ye);const te=document.getElementById("profLevelContainer"),we=document.createElement("div");we.textContent="Proficiency: ";we.classList.add("moon-phase-label");we.style.marginTop="4px";te==null||te.appendChild(we);const Le=document.createElement("input");Le.id="profInput";Le.type="number";Le.classList.add("moon-mage-stuff");te==null||te.appendChild(Le);const Nt=document.getElementById("moonContainer"),D=document.getElementById("currentDay"),R=document.getElementById("currentMonth");q.onReady(async()=>{const n=await q.theme.getTheme();Bt(n,document),q.theme.onChange(h=>{Bt(h,document)});const e=await q.player.getRole(),o=(await q.room.getMetadata())[`${Ae.EXTENSIONID}/saveData`];if(l(),r(),d(),o&&B(o),e==="PLAYER"){document.getElementById("floating-header").style.display="none",document.getElementById("calendar").style.marginTop="0",q.room.onMetadataChange(h=>{const f=h[`${Ae.EXTENSIONID}/saveData`];f&&B(f)});return}const s=document.querySelectorAll("#floating-header button"),i=document.querySelectorAll(".content");s.forEach(h=>{h.addEventListener("click",function(){var m;let f=(m=h.textContent)==null?void 0:m.toLowerCase();f==="generate"&&(f="calendar"),f&&(i.forEach(_=>{_.style.display=_.id===f?"block":"none"}),s.forEach(_=>{_.classList.remove("button-selected")}),h===_o?mo.classList.add("button-selected"):h.classList.add("button-selected"))})}),R.onchange=()=>E(),D.onchange=()=>E(),ho.onclick=()=>a(),fo.onclick=()=>B(),J.onchange=()=>d(),de.onchange=()=>l(),V.onchange=()=>r();function r(){At.innerHTML="";for(let h=1;h<=+V.value;h++){const f=document.createElement("div");f.innerHTML=`
            <label for="month${h}Name">Name ${h}:</label>
            <input type="text" id="month${h}Name" name="month${h}Name" value="Month${h}">
    
            <label for="month${h}Days">Days:</label>
            <input type="number" class="input-mini" id="month${h}Days" name="month${h}Days" min="1" value="30">
          `,At.appendChild(f)}}function d(){Ct.innerHTML="";for(let h=1;h<=+J.value;h++){const f=document.createElement("div");f.innerHTML=`
            <label for="day${h}Name">Day ${h} Name:</label>
            <input type="text" id="day${h}Name" name="day${h}Name" value="Day${h}">
          `,Ct.appendChild(f)}}function l(){Rt.innerHTML="";for(let h=1;h<=+de.value;h++){const f=document.createElement("div");f.innerHTML=`
            <label for="moon${h}Name">Name ${h}:</label>
            <input type="text" class="moon-input" id="moon${h}Name" name="moon${h}Name" value="Moon${h}">
    
            <label for="moon${h}Cycle">Cycle ${h} (days):</label>
            <input type="number" class="input-mini" id="moon${h}Cycle" name="moon${h}Cycle" min="1" value="30">
    
            <label for="moon${h}Shift">Shift ${h}:</label>
            <input type="number" class="input-mini" id="moon${h}Shift" name="moon${h}Shift" min="0" value="0">
          `,Rt.appendChild(f)}}function u(h,f,m){return document.getElementById(`${h}${f}${m}`).value}async function a(){const h=[],f=[];for(let p=1;p<=+V.value;p++){const A=u("month",p,"Name"),C=u("month",p,"Days");h.push(A),f.push(C)}const m=[];for(let p=1;p<=+J.value;p++){const A=u("day",p,"Name");m.push(A)}const _=document.createElement("div");_.classList.add("calendar-system-container");const y=document.createElement("button");y.title="DayBack",y.classList.add("day-back-button"),y.style.background="url(./back-day.svg) no-repeat center center",y.style.backgroundSize="contain",y.onclick=()=>{D.value=(+D.value-1).toString(),E()};const O=document.createElement("button");O.title="DayForward",O.classList.add("day-forward-button"),O.style.background="url(./forward-day.svg) no-repeat center center",O.style.backgroundSize="contain",O.onclick=()=>{D.value=(+D.value+1).toString(),E()},ge.innerHTML="",e==="GM"&&ge.appendChild(y),ge.appendChild(document.createTextNode(Ve.value)),e==="GM"&&ge.appendChild(O);for(let p=0;p<+V.value;p++){const A=document.createElement("button");A.title="MonBack",A.classList.add("mon-back-button"),A.style.background="url(./back-month.svg) no-repeat center center",A.style.backgroundSize="contain",A.onclick=()=>{R.value=Math.max(+R.value-1,1).toString(),v()};const C=document.createElement("button");C.title="MonForward",C.classList.add("mon-forward-button"),C.style.background="url(./forward-month.svg) no-repeat center center",C.style.backgroundSize="contain",C.onclick=()=>{R.value=Math.max(+R.value+1,1).toString(),v()};const x=document.createElement("table");x.classList.add("calendar-system"),x.id=`monthTable${p}`;const W=h[p]?h[p]:`Month ${(p+1).toString()}`,X=x.insertRow();X.classList.add("month-row");const Y=X.insertCell();Y.classList.add("month-header-cell"),Y.appendChild(A),Y.appendChild(document.createTextNode(W)),Y.appendChild(C),Y.colSpan=+J.value;const oe=x.insertRow();for(const k of m){const De=oe.insertCell();De.textContent=k,De.classList.add("day-header")}let F=1;for(let k=1;k<=+f[p];k++){F===1&&x.insertRow();const Ee=x.rows[x.rows.length-1].insertCell();Ee.textContent=`${k}`,Ee.setAttribute("data-month",(p+1).toString()),Ee.setAttribute("data-day",k.toString()),Ee.classList.add("day-cell"),F++,F>+J.value&&(F=1)}_.appendChild(x)}St.innerHTML="",St.appendChild(_),await E()}function c(){const h=[];for(let y=1;y<=+J.value;y++){const O=u("day",y,"Name");h.push(O)}const f=[];for(let y=1;y<=+V.value;y++){const O=u("month",y,"Name"),p=u("month",y,"Days");f.push({Name:O,Days:p})}const m=[];for(let y=1;y<=+de.value;y++){const O=u("moon",y,"Name"),p=u("moon",y,"Cycle"),A=u("moon",y,"Shift");m.push({Name:O,Cycle:p,Shift:A})}return{NameYear:Ve.value,CurrentDay:D.value,CurrentMonth:R.value,NumberMonth:V.value,DaysPerWeek:J.value,NumberMoons:de.value,MoonSet:m,MonthSet:f,DaySet:h}}function v(){const h=document.querySelectorAll(".calendar-system");for(const f of h){const m=+R.value-1;f.id===`monthTable${m}`?f.style.display="table":f.style.display="none"}}async function E(){const h=u("month",+R.value,"Days");if(+D.value>+h){let y=+R.value+1;y>+V.value?(D.value="1",R.value="1"):(R.value=y.toString(),D.value="1")}else if(+D.value<1){let y=+R.value-1;if(y<1){const O=u("month",+V.value-1,"Days");D.value=O,R.value=V.value}else{const O=u("month",y,"Days");R.value=(+R.value-1).toString(),D.value=O}}document.querySelectorAll(".calendar-system td").forEach(y=>y.classList.remove("current-date"));const m=document.querySelector(`.calendar-system td[data-month="${R.value}"][data-day="${D.value}"]`);m&&m.classList.add("current-date"),v();const _=[];for(let y=1;y<=+de.value;y++){const O=u("moon",y,"Name"),p=u("moon",y,"Cycle"),A=u("moon",y,"Shift");_.push({name:O,cycle:p,shift:A})}Nt.innerHTML="";for(const y of _){const O=T(+D.value,+y.cycle,+y.shift,y.name);Nt.appendChild(O)}if(e==="GM"){const y=c();await q.room.setMetadata({[`${Ae.EXTENSIONID}/saveData`]:y})}}function T(h,f,m,_){const O=(h+m-1)%f/f;let p,A,C;O<.0625||O>=.9375?(p="/new_moon.png",A="New Moon",C="20"):O<.1875?(p="/waxing_crescent.png",A="Waxing Crescent",C="15"):O<.3125?(p="/first_quarter.png",A="First Quarter",C="10"):O<.4375?(p="/waxing_gibbous.png",A="Waxing Gibbous",C="8"):O<.5625?(p="/full_moon.png",A="Full Moon",C="5"):O<.6875?(p="/waning_gibbous.png",A="Waning Gibbous",C="8"):O<.8125?(p="/third_quarter.png",A="Third Quarter",C="10"):(p="/waning_crescent.png",A="Waning Crescent",C="15");let x=lo(_);switch(_){case"Katamba":x="#000000";break;case"Yavash":x="#FF0000";break;case"Xibar":x="#739BD0";break}const W=document.createElement("div"),X=document.createElement("section");X.classList.add("moon-icon"),X.style.setProperty("--moon-color",x);const Y=document.createElement("label");Y.textContent=_,Y.classList.add("moon-name-label");const oe=document.createElement("label");oe.textContent=`Spell DC: ${+C+j}`,oe.setAttribute("data-dc",C),oe.classList.add("moon-dc-label");const F=document.createElement("label");F.textContent=A,F.classList.add("moon-phase-label");const k=document.createElement("img");return k.src=p,k.classList.add("moon-image"),k.title=_,X.appendChild(k),W.appendChild(F),W.appendChild(X),W.appendChild(Y),(_==="Xibar"||_==="Katamba"||_==="Yavash")&&(W.appendChild(document.createElement("br")),W.appendChild(oe),ee.style.display="block",te.style.display="block"),W}function B(h){const f=document.getElementById("donjonJson").value;let m;try{h?(m=M(h),R.value=h.CurrentMonth,D.value=h.CurrentDay):m=JSON.parse(f),Ve.value=m.year?m.year:"Default Calendar Name",V.value=m.n_months?m.n_months:"12",r();for(let _=1;_<=m.n_months;_++)document.getElementById(`month${_}Name`).value=m.months[_-1]?m.months[_-1]:`DefaultMonth#${_}`,document.getElementById(`month${_}Days`).value=m.month_len[m.months[_-1]]?m.month_len[m.months[_-1]]:"28";document.getElementById("daysPerWeek").value=m.weekdays.length>0?m.weekdays.length:"7",d();for(let _=1;_<=m.weekdays.length;_++)document.getElementById(`day${_}Name`).value=m.weekdays[_-1]?m.weekdays[_-1]:`DefaultDay#${_}`;document.getElementById("numMoons").value=m.n_moons?m.n_moons:"2",l();for(let _=1;_<=m.n_moons;_++)document.getElementById(`moon${_}Name`).value=m.moons[_-1]?m.moons[_-1]:`DefaultMoon#${_}`,document.getElementById(`moon${_}Cycle`).value=m.lunar_cyc[m.moons[_-1]]?m.lunar_cyc[m.moons[_-1]]:"28",document.getElementById(`moon${_}Shift`).value=m.lunar_shf[m.moons[_-1]]?m.lunar_shf[m.moons[_-1]]:"0";document.getElementById("totalDaysInYear").value=m.year_len?m.year_len:"336",a()}catch(_){alert("Invalid Calendar Format."),console.error(_)}}function M(h){const f={};return f.year=h.NameYear||"Default Calendar Name",f.n_months=h.NumberMonth||"12",f.months=[],f.month_len={},h.MonthSet.forEach((m,_)=>{f.months[_]=m.Name||`DefaultMonth#${_+1}`,f.month_len[f.months[_]]=m.Days||"28"}),f.weekdays=h.DaySet||["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"],f.weekdays.forEach((m,_)=>{f.weekdays[_]=m||`DefaultDay#${_+1}`}),f.n_moons=h.NumberMoons||"2",f.moons=[],f.lunar_cyc={},f.lunar_shf={},h.MoonSet.forEach((m,_)=>{f.moons[_]=m.Name||`DefaultMoon#${_+1}`,f.lunar_cyc[f.moons[_]]=m.Cycle||"28",f.lunar_shf[f.moons[_]]=m.Shift||"0"}),f.year_len=h.DaysPerWeek||"336",f}});
