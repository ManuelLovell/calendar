import{C as _,O as M}from"./constants-iwhneteH.js";let z={};function he(s){let r=0;if(s.length===0)return r;for(let N=0;N<s.length;N++){const g=s.charCodeAt(N);r=(r<<5)-r+g,r&=r}return r}function pe(s){return`hsl(${(he(s)%360+360)%360}, 70%, 60%)`}function fe(s,r,N="CALENDAR"){const g=`${r}_${N}}`,D=z[g];if(D)if(D!==s){const I=new Date(s),d=new Date().getTime()-I.getTime(),L=60*1e3;return d>=L?!0:(z[g]=s,!1)}else return!0;else{const I=new Date(s),d=new Date().getTime()-I.getTime(),L=60*1e3;return d>=L?!0:(z[g]=s,!1)}}function te(s,r){const N=window.matchMedia("(prefers-color-scheme: dark)"),g=N.matches?"dark":"light",D=N.matches?"light":"dark";for(var I=0;I<r.styleSheets.length;I++)for(var E=0;E<r.styleSheets[I].cssRules.length;E++){let d=r.styleSheets[I].cssRules[E];d&&d.media&&d.media.mediaText.includes("prefers-color-scheme")&&(s.mode=="LIGHT"?(d.media.appendMedium(`(prefers-color-scheme: ${g})`),d.media.mediaText.includes(D)&&d.media.deleteMedium(`(prefers-color-scheme: ${D})`)):s.mode=="DARK"&&(d.media.appendMedium(`(prefers-color-scheme: ${D})`),d.media.mediaText.includes(g)&&d.media.deleteMedium(`(prefers-color-scheme: ${g})`)))}}function ge(){const s=document.createElement("img");s.id="whatsNewButton",s.setAttribute("class","icon"),s.classList.add("clickable"),s.style.marginLeft="10px",s.style.cursor="pointer",s.setAttribute("title","Whats New?"),s.setAttribute("src","/info.svg"),s.onclick=async function(){try{localStorage.setItem(_.VERSION,"true"),s.classList.remove("whats-new-shine")}catch{}await M.modal.open({id:_.EXTENSIONWHATSNEW,url:"/bswhatsnew.html",height:500,width:350})};try{localStorage.getItem(_.VERSION)!=="true"&&s.classList.add("whats-new-shine")}catch{}return s}document.querySelector("#app").innerHTML=`
<div id="floating-header">
  <button id="calendarButton" class="button-selected" (click)="toggleContent('calendar')">Calendar</button>
  <button (click)="toggleContent('months')">Months</button>
  <button (click)="toggleContent('days')">Days</button>
  <button (click)="toggleContent('moons')">Moons</button>
  <button (click)="toggleContent('import')">Import</button>
  <button id="generateCalendar">Generate</button>
  <div id="whatsNew"></div>
</div>

<div id="calendar" class="content">
    <h2 id="titleLine"><div id="spellLevelContainer" style="display:none;"></div><div id="titleName">Calendar!</div><div id="profLevelContainer" style="display:none;"></div></h2>
    <div id="moonContainer"></div>
    <div id="calendarOutput"></div>
</div>

<div id="months" class="content" style="display:none;">
    <label for="calendarName">Calendar Name/Year:</label>
    <input type="text" id="calendarName" name="calendarName" value="Testers">
    </br>
    <label for="currentMonth">Current Month:</label>
    <input type="number" class="input-mini" id="currentMonth" name="currentMonth" value="1">
    </br>
    <label for="numMonths">Number of Months:</label>
    <input type="number" class="input-mini" id="numMonths" name="numMonths" min="1" value="12">
    <div id="monthInputContainer"></div>
</div>

<div id="days" class="content" style="display:none;">
    <label for="startDayYear">Year Begins on WeekDay:</label>
    <input type="number" class="input-mini" id="startDayYear" name="startDayYear" value="1">
    </br>
    <label for="currentDay">Current Day:</label>
    <input type="number" class="input-mini" id="currentDay" name="currentDay" value="1">
    </br>
    <label for="daysPerWeek">Days per Week:</label>
    <input type="number" class="input-mini" id="daysPerWeek" name="daysPerWeek" min="1" value="7">
    <div id="dayNameInputContainer"></div>
        
    <input type="number" style="display: none;" class="input-mini" id="totalDaysInYear" name="totalDaysInYear" min="1" value="365">
</div>

<div id="moons" class="content" style="display:none;">
    <label for="numMoons">Number of Moons:</label>
    <input type="number" class="input-mini" id="numMoons" name="numMoons" min="1" value="1">
    <div id="moonInputContainer"></div>
</div>

<div id="import" class="content" style="display:none;">
    <label for="donjonJson">DonJon Calendar Importer:</label>
    </br>
    <textarea id="donjonJson" rows="20" style="width: 100%;"></textarea>
    </br>
    <button id="importDonJon">Import DonJon Calendar</button>
</div>
<div class="bottom-border"></div>
`;const K=document.getElementById("calendarName"),$=document.getElementById("daysPerWeek"),Q=document.getElementById("startDayYear"),ne=document.getElementById("monthInputContainer"),w=document.getElementById("numMonths"),ae=document.getElementById("dayNameInputContainer"),oe=document.getElementById("moonInputContainer"),Y=document.getElementById("numMoons"),be=document.getElementById("generateCalendar"),ve=document.getElementById("importDonJon"),le=document.getElementById("calendarOutput"),se=document.getElementById("calendarButton"),Ce=document.getElementById("generateCalendar"),O=document.getElementById("titleName"),De=document.getElementById("whatsNew");De.appendChild(ge());let T=1,re=1;const U=document.getElementById("spellLevelContainer"),J=document.createElement("div");let k=0;J.textContent="SpellLevel: ";J.classList.add("moon-phase-label");J.style.marginTop="4px";U?.appendChild(J);const H=document.createElement("input");H.id="spellInput";H.type="number";H.classList.add("moon-mage-stuff");H.onchange=s=>{switch(+s.target.value){case 0:k=0;break;case 1:k=0;break;case 2:k=2;break;case 3:k=4;break;case 4:k=6;break;case 5:k=8;break;default:k=8;break}const g=document.querySelectorAll(".moon-dc-label");for(const D of g){const I=+D.getAttribute("data-dc");D.textContent=`Spell DC: ${(I+k).toString()}`}};U?.appendChild(H);const Z=document.getElementById("profLevelContainer"),X=document.createElement("div");X.textContent="Proficiency: ";X.classList.add("moon-phase-label");X.style.marginTop="4px";Z?.appendChild(X);const q=document.createElement("input");q.id="profInput";q.type="number";q.classList.add("moon-mage-stuff");Z?.appendChild(q);const ce=document.getElementById("moonContainer"),m=document.getElementById("currentDay"),p=document.getElementById("currentMonth");M.onReady(async()=>{const s=await M.theme.getTheme();te(s,document),M.theme.onChange(t=>{te(t,document)});const r=await M.player.getRole(),g=(await M.room.getMetadata())[`${_.EXTENSIONID}/saveData`];if(L(),E(),d(),g&&await V(g),r==="GM"&&(document.getElementById("calendar").style.height="94%"),r==="PLAYER"){document.getElementById("floating-header").style.display="none",document.getElementById("calendar").style.marginTop="0",document.getElementById("titleLine").style.marginTop="2px",M.room.onMetadataChange(async t=>{const a=t[`${_.EXTENSIONID}/saveData`];a&&await V(a)});return}M.room.onMetadataChange(async t=>{const a=t[`${_.OUTSIDEID}/data`];a&&(fe(a.Timestamp,"Outside","CALENDAR")||(m.value=(+m.value+ +a.Increment).toString(),await x()))});const D=document.querySelectorAll("#floating-header button"),I=document.querySelectorAll(".content");D.forEach(t=>{t.addEventListener("click",function(){let a=t.textContent?.toLowerCase();a==="generate"&&(a="calendar"),a&&(I.forEach(n=>{n.style.display=n.id===a?"block":"none"}),D.forEach(n=>{n.classList.remove("button-selected")}),t===Ce?se.classList.add("button-selected"):t.classList.add("button-selected"))})}),p.onchange=async()=>await x(),m.onchange=async()=>await x(),be.onclick=async()=>await F(),ve.onclick=async()=>await V(),$.onchange=()=>d(),Y.onchange=()=>L(),w.onchange=()=>E();function E(){ne.innerHTML="";for(let t=1;t<=+w.value;t++){const a=document.createElement("div");a.innerHTML=`
            <label for="month${t}Name">Name ${t}:</label>
            <input type="text" id="month${t}Name" name="month${t}Name" value="Month${t}">
    
            <label for="month${t}Days">Days:</label>
            <input type="number" class="input-mini" id="month${t}Days" name="month${t}Days" min="1" value="30">
          `,ne.appendChild(a)}}function d(){ae.innerHTML="";for(let t=1;t<=+$.value;t++){const a=document.createElement("div");a.innerHTML=`
            <label for="day${t}Name">Day ${t} Name:</label>
            <input type="text" id="day${t}Name" name="day${t}Name" value="Day${t}">
          `,ae.appendChild(a)}}function L(){oe.innerHTML="";for(let t=1;t<=+Y.value;t++){const a=document.createElement("div");a.innerHTML=`
            <label for="moon${t}Name">Name ${t}:</label>
            <input type="text" class="moon-input" id="moon${t}Name" name="moon${t}Name" value="Moon${t}">
    
            <label for="moon${t}Cycle">Cycle ${t} (days):</label>
            <input type="number" class="input-mini" id="moon${t}Cycle" name="moon${t}Cycle" min="1" value="30">
    
            <label for="moon${t}Shift">Shift ${t}:</label>
            <input type="number" class="input-mini" id="moon${t}Shift" name="moon${t}Shift" min="0" value="0">
          `,oe.appendChild(a)}}function f(t,a,n){return document.getElementById(`${t}${a}${n}`).value}async function F(){const t=[],a=[];for(let c=1;c<=+w.value;c++){const y=f("month",c,"Name"),C=f("month",c,"Days");t.push(y),a.push(C)}const n=[];for(let c=1;c<=+$.value;c++){const y=f("day",c,"Name");n.push(y)}const o=document.createElement("div");o.classList.add("calendar-system-container");const e=document.createElement("button");e.title="Select Previous Day",e.classList.add("day-back-button"),e.classList.add("clickable"),e.style.background="url(./back-day.svg) no-repeat center center",e.style.backgroundSize="contain",e.onclick=async()=>{m.value=(+m.value-1).toString(),await x()};const l=document.createElement("button");l.title="Select Next Day",l.classList.add("day-forward-button"),l.classList.add("clickable"),l.style.background="url(./forward-day.svg) no-repeat center center",l.style.backgroundSize="contain",l.onclick=async()=>{m.value=(+m.value+1).toString(),await x()},O.innerHTML="",r==="GM"&&O.appendChild(e),O.appendChild(document.createTextNode(K.value)),r==="GM"&&O.appendChild(l);const i=parseInt(Q.value),u=parseInt($.value);let v=i>u?i%u:i,S=!0;for(let c=0;c<+w.value;c++){const y=document.createElement("button");y.title="View previous Month",y.classList.add("mon-back-button"),y.classList.add("clickable"),y.style.background="url(./back-month.svg) no-repeat center center",y.style.backgroundSize="contain",y.onclick=()=>{let b=T-1;b<1&&(b=+w.value),T=b,G()};const C=document.createElement("button");C.title="View next Month",C.classList.add("mon-forward-button"),C.classList.add("clickable"),C.style.background="url(./forward-month.svg) no-repeat center center",C.style.backgroundSize="contain",C.onclick=async()=>{let b=T+1;b>+w.value&&(b=1),T=b,G()};const h=document.createElement("table");h.classList.add("calendar-system"),h.id=`monthTable${c}`;const A=t[c]?t[c]:`Month ${(c+1).toString()}`,B=h.insertRow();B.classList.add("month-row");const R=B.insertCell();R.classList.add("month-header-cell"),R.appendChild(y),R.appendChild(document.createTextNode(A)),R.appendChild(C),R.colSpan=+$.value;const ue=h.insertRow();for(const b of n){const j=ue.insertCell();j.textContent=b,j.classList.add("day-header")}let W=v;for(let b=1;b<=+a[c];b++){if(S){h.insertRow();const ye=h.rows[h.rows.length-1];for(let ee=1;ee<W;ee++)ye.insertCell();S=!1}else W===1&&h.insertRow();const P=h.rows[h.rows.length-1].insertCell();P.textContent=`${b}`,P.setAttribute("data-month",(c+1).toString()),P.setAttribute("data-day",b.toString()),P.classList.add("day-cell"),W++,W>+$.value&&(W=1)}v=W,S=!0,o.appendChild(h)}le.innerHTML="",le.appendChild(o),T=+p.value,await x()}function ie(){const t=[];for(let e=1;e<=+$.value;e++){const l=f("day",e,"Name");t.push(l)}const a=[];for(let e=1;e<=+w.value;e++){const l=f("month",e,"Name"),i=f("month",e,"Days");a.push({Name:l,Days:i})}const n=[];for(let e=1;e<=+Y.value;e++){const l=f("moon",e,"Name"),i=f("moon",e,"Cycle"),u=f("moon",e,"Shift");n.push({Name:l,Cycle:i,Shift:u})}return{NameYear:K.value,CurrentDay:m.value,StartDayYear:(parseInt(Q.value)-1).toString(),CurrentMonth:p.value,NumberMonth:w.value,DaysPerWeek:$.value,NumberMoons:Y.value,MoonSet:n,MonthSet:a,DaySet:t}}function G(t=!1){const a=document.querySelectorAll(".calendar-system");let n=T!==+p.value?T:+p.value;t&&(n=+p.value);let o=re<n;for(const e of a)e.id===`monthTable${n-1}`?setTimeout(()=>{re=n,e.style.display="table",e.style.transform=o?"translateX(100%)":"translateX(-100%)",e.offsetHeight,e.style.transform="translateX(0%)",e.style.transition="transform 0.2s ease-in-out"},200):(e.style.transform=o?"translateX(-100%)":"translateX(100%)",e.style.transition="transform 0.2s ease-in-out",setTimeout(()=>{e.style.display="none"},200))}async function x(){const t=f("month",+p.value,"Days");if(+m.value>+t){let e=+p.value+1;e>+w.value?(m.value="1",p.value="1"):(p.value=e.toString(),m.value="1")}else if(+m.value<1){let e=+p.value-1;if(e<1){const l=f("month",+w.value-1,"Days");m.value=l,p.value=w.value}else{const l=f("month",e,"Days");p.value=(+p.value-1).toString(),m.value=l}}document.querySelectorAll(".calendar-system td").forEach(e=>e.classList.remove("current-date"));const n=document.querySelector(`.calendar-system td[data-month="${p.value}"][data-day="${m.value}"]`);n&&n.classList.add("current-date"),G(!0);const o=[];for(let e=1;e<=+Y.value;e++){const l=f("moon",e,"Name"),i=f("moon",e,"Cycle"),u=f("moon",e,"Shift");o.push({name:l,cycle:i,shift:u})}ce.innerHTML="";for(const e of o){const l=de(+m.value,+e.cycle,+e.shift,e.name);ce.appendChild(l)}if(r==="GM"){const e=ie();await M.room.setMetadata({[`${_.EXTENSIONID}/saveData`]:e});const l=e?.MonthSet[+e.CurrentMonth-1]?.Name;await M.action.setBadgeText(`${l??e?.CurrentMonth}:${e?.CurrentDay}`)}}function de(t,a,n,o){const l=(t+n-1)%a/a;let i,u,v;l<.0625||l>=.9375?(i="/new_moon.png",u="New Moon",v="20"):l<.1875?(i="/waxing_crescent.png",u="Waxing Crescent",v="15"):l<.3125?(i="/first_quarter.png",u="First Quarter",v="10"):l<.4375?(i="/waxing_gibbous.png",u="Waxing Gibbous",v="8"):l<.5625?(i="/full_moon.png",u="Full Moon",v="5"):l<.6875?(i="/waning_gibbous.png",u="Waning Gibbous",v="8"):l<.8125?(i="/third_quarter.png",u="Third Quarter",v="10"):(i="/waning_crescent.png",u="Waning Crescent",v="15");let S=pe(o);switch(o){case"Katamba":S="#000000";break;case"Yavash":S="#FF0000";break;case"Xibar":S="#739BD0";break}const c=document.createElement("div"),y=document.createElement("section");y.classList.add("moon-icon"),y.style.setProperty("--moon-color",S);const C=document.createElement("label");C.textContent=o,C.classList.add("moon-name-label");const h=document.createElement("label");h.textContent=`Spell DC: ${+v+k}`,h.setAttribute("data-dc",v),h.classList.add("moon-dc-label");const A=document.createElement("label");A.textContent=u,A.classList.add("moon-phase-label");const B=document.createElement("img");return B.src=i,B.classList.add("moon-image"),B.title=o,y.appendChild(B),c.appendChild(A),c.appendChild(y),c.appendChild(C),(o==="Xibar"||o==="Katamba"||o==="Yavash")&&(c.appendChild(document.createElement("br")),c.appendChild(h),U.style.display="block",Z.style.display="block"),c}async function V(t){const a=document.getElementById("donjonJson").value;let n;try{t?(n=me(t),p.value=t.CurrentMonth,m.value=t.CurrentDay):n=JSON.parse(a),K.value=n.year?n.year:"Default Calendar Name",w.value=n.n_months?n.n_months:"12",E();for(let e=1;e<=n.n_months;e++)document.getElementById(`month${e}Name`).value=n.months[e-1]?n.months[e-1]:`DefaultMonth#${e}`,document.getElementById(`month${e}Days`).value=n.month_len[n.months[e-1]]?n.month_len[n.months[e-1]]:"28";document.getElementById("daysPerWeek").value=n.weekdays.length>0?n.weekdays.length:"7",d();for(let e=1;e<=n.weekdays.length;e++)document.getElementById(`day${e}Name`).value=n.weekdays[e-1]?n.weekdays[e-1]:`DefaultDay#${e}`;document.getElementById("numMoons").value=n.n_moons?n.n_moons:"2",L();for(let e=1;e<=n.n_moons;e++)document.getElementById(`moon${e}Name`).value=n.moons[e-1]?n.moons[e-1]:`DefaultMoon#${e}`,document.getElementById(`moon${e}Cycle`).value=n.lunar_cyc[n.moons[e-1]]?n.lunar_cyc[n.moons[e-1]]:"28",document.getElementById(`moon${e}Shift`).value=n.lunar_shf[n.moons[e-1]]?n.lunar_shf[n.moons[e-1]]:"0";document.getElementById("totalDaysInYear").value=n.year_len?n.year_len:"336",Q.value=n.first_day?(parseInt(n.first_day)+1).toString():"1",await F();const o=t?.MonthSet[+t.CurrentMonth-1]?.Name;await M.action.setBadgeText(`${o??t?.CurrentMonth}:${t?.CurrentDay}`),t||(se.click(),await M.notification.show("Calendar Imported Successfully!","SUCCESS"))}catch(o){alert("Invalid Calendar Format."),console.error(o)}}function me(t){const a={};return a.year=t.NameYear||"Default Calendar Name",a.n_months=t.NumberMonth||"12",a.months=[],a.month_len={},t.MonthSet.forEach((n,o)=>{a.months[o]=n.Name||`DefaultMonth#${o+1}`,a.month_len[a.months[o]]=n.Days||"28"}),a.weekdays=t.DaySet||["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"],a.weekdays.forEach((n,o)=>{a.weekdays[o]=n||`DefaultDay#${o+1}`}),a.n_moons=t.NumberMoons||"2",a.moons=[],a.lunar_cyc={},a.lunar_shf={},t.MoonSet.forEach((n,o)=>{a.moons[o]=n.Name||`DefaultMoon#${o+1}`,a.lunar_cyc[a.moons[o]]=n.Cycle||"28",a.lunar_shf[a.moons[o]]=n.Shift||"0"}),a.year_len=t.DaysPerWeek||"336",a.first_day=t.StartDayYear||"0",a}});
